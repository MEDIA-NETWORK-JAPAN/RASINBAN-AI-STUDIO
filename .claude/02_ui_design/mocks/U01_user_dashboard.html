<!DOCTYPE html>
<!--
================================================================================
【画面名称】一般ユーザー用 ダッシュボード (User Dashboard)
【ファイル名】U01_user_dashboard.html

【概要】
ログインした一般ユーザー（拠点ユーザー）が自分の利用状況を確認するための画面です。

【設計変更点 (APIキー設計変更 v1.6 対応)】
- 旧設計: 「拠点ダッシュボード」= 拠点単位の集計
- 新設計: 「ユーザーダッシュボード」= ログインユーザー個人の利用量を表示
- user.plan から上限を取得（拠点プランではなくユーザープラン）
- user_api_keys の状態（有効/無効）も表示

【主な機能】
1. ユーザー情報サマリー
   - ユーザー名・所属拠点・契約プラン・APIキー状態
2. 今月の利用状況 KPIカード
   - 今月の総利用回数（合計）
   - プラン上限
   - 利用率（%）
3. アプリ別利用状況テーブル
   - 利用アプリ、利用回数、上限、プログレスバー
4. (閲覧専用 - 編集機能なし)

【使用ライブラリ (CDN)】
- Tailwind CSS (v3.4)
- Alpine.js
- FontAwesome
================================================================================
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ダッシュボード - Dify Gateway</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased"
      x-data="{
          sidebarOpen: false,

          // ログインユーザー情報 (モック)
          currentUser: {
              name: '田中 太郎',
              email: 'taro.tanaka@example.com',
              team: '東京本社 営業部',
              plan: 'Standard Plan',
              planLimit: 100000,
              apiKeyStatus: 'active',  // 'active' | 'inactive'
              apiKeyLastUsed: '2023-10-25 14:30'
          },

          // アプリ別利用データ (モック)
          appUsages: [
              { id: 1, app: 'カスタマーサポートBot', appIcon: 'fa-robot', appColor: 'indigo', count: 45280, limit: 100000 },
              { id: 2, app: '日報要約ジェネレーター', appIcon: 'fa-file-alt', appColor: 'purple', count: 12450, limit: 100000 },
              { id: 3, app: '社内QA検索', appIcon: 'fa-search', appColor: 'green', count: 8200, limit: 100000 },
          ],

          // 今月の合計利用数
          get totalCount() {
              return this.appUsages.reduce((sum, u) => sum + u.count, 0);
          },

          // 利用率計算
          get usagePercent() {
              return Math.min(100, Math.round((this.totalCount / this.currentUser.planLimit) * 100));
          },

          // プログレスバーの色
          getProgressColor(count, limit) {
              const pct = (count / limit) * 100;
              if (pct > 100) return 'bg-red-600';
              if (pct > 90) return 'bg-yellow-500';
              return 'bg-blue-500';
          },

          getPercentage(count, limit) {
              if (!limit) return 0;
              return Math.min(100, Math.round((count / limit) * 100));
          }
      }">

    <!-- ▼▼▼ Mobile Header ▼▼▼ -->
    <div class="lg:hidden flex items-center justify-between bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-30">
        <div class="flex items-center gap-3">
            <button @click="sidebarOpen = !sidebarOpen" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <span class="font-bold text-lg text-gray-900">Gateway</span>
        </div>
        <div class="flex items-center gap-2">
            <img src="https://ui-avatars.com/api/?name=Tanaka+Taro&background=6366f1&color=fff" alt="User" class="h-8 w-8 rounded-full object-cover shadow-sm">
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">

        <!-- ▼▼▼ Sidebar Navigation ▼▼▼ -->
        <div x-show="sidebarOpen" @click="sidebarOpen = false" x-transition.opacity
             class="fixed inset-0 z-40 bg-gray-900/50 lg:hidden" x-cloak></div>

        <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'"
               class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-300 ease-in-out lg:static lg:translate-x-0 flex flex-col">

            <div class="h-16 flex items-center px-6 border-b border-gray-100">
                <div class="flex items-center gap-2 text-indigo-600">
                    <i class="fas fa-network-wired text-xl"></i>
                    <span class="font-bold text-xl tracking-tight text-gray-900">Dify <span class="text-indigo-600">Gateway</span></span>
                </div>
            </div>

            <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
                <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Menu</p>

                <!-- Active Link -->
                <a href="#" class="flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg bg-indigo-50 text-indigo-700 group">
                    <i class="fas fa-chart-bar w-5 text-center group-hover:text-indigo-600"></i>
                    ダッシュボード
                </a>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <div class="flex items-center gap-3">
                    <img src="https://ui-avatars.com/api/?name=Tanaka+Taro&background=6366f1&color=fff" alt="User" class="h-9 w-9 rounded-full object-cover shadow-sm">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate" x-text="currentUser.name"></p>
                        <p class="text-xs text-gray-500 truncate" x-text="currentUser.team"></p>
                    </div>
                    <a href="#" class="text-gray-400 hover:text-gray-600" title="ログアウト">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </aside>

        <!-- ▼▼▼ Main Content Area ▼▼▼ -->
        <div class="flex-1 flex flex-col overflow-hidden bg-gray-50">

            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">マイダッシュボード</h1>
                    <p class="text-xs text-gray-500 mt-1" x-text="currentUser.team + ' / ' + currentUser.plan"></p>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <i class="fas fa-calendar-alt"></i>
                    <span>2023年10月</span>
                </div>
            </header>

            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-4 lg:p-8">

                <div class="max-w-4xl mx-auto space-y-6">

                    <!-- ▼▼▼ ユーザー情報サマリー ▼▼▼ -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                            <img src="https://ui-avatars.com/api/?name=Tanaka+Taro&background=6366f1&color=fff&size=80" alt="User" class="h-16 w-16 rounded-full object-cover shadow-md mx-auto sm:mx-0">
                            <div class="flex-1 text-center sm:text-left">
                                <h2 class="text-lg font-bold text-gray-900" x-text="currentUser.name"></h2>
                                <p class="text-sm text-gray-500" x-text="currentUser.email"></p>
                                <div class="flex flex-wrap gap-2 mt-2 justify-center sm:justify-start">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
                                        <i class="fas fa-building mr-1 text-gray-400"></i>
                                        <span x-text="currentUser.team"></span>
                                    </span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">
                                        <i class="fas fa-tag mr-1"></i>
                                        <span x-text="currentUser.plan"></span>
                                    </span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                        <i class="fas fa-key mr-1"></i>
                                        APIキー: 有効
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ▲▲▲ ユーザー情報サマリー End ▲▲▲ -->

                    <!-- ▼▼▼ KPIカード (今月の利用状況) ▼▼▼ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                        <!-- Card 1: 今月の利用回数 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-gray-500">今月の総利用回数</h3>
                                <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-3xl font-bold text-gray-900" x-text="totalCount.toLocaleString()"></span>
                                <span class="text-sm text-gray-400">回</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">全アプリ合計</p>
                        </div>

                        <!-- Card 2: プラン上限 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-gray-500">プラン月間上限</h3>
                                <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                                    <i class="fas fa-tachometer-alt"></i>
                                </div>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-3xl font-bold text-gray-900" x-text="(currentUser.planLimit / 1000).toFixed(0) + 'k'"></span>
                                <span class="text-sm text-gray-400">req/mo</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-2" x-text="currentUser.plan"></p>
                        </div>

                        <!-- Card 3: 利用率 -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-gray-500">今月の利用率</h3>
                                <div class="p-2 rounded-lg"
                                     :class="usagePercent > 90 ? 'bg-red-50 text-red-600' : usagePercent > 70 ? 'bg-yellow-50 text-yellow-600' : 'bg-green-50 text-green-600'">
                                    <i class="fas fa-percent"></i>
                                </div>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-3xl font-bold"
                                      :class="usagePercent > 90 ? 'text-red-600' : usagePercent > 70 ? 'text-yellow-600' : 'text-gray-900'"
                                      x-text="usagePercent + '%'"></span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 mt-3">
                                <div class="h-1.5 rounded-full transition-all duration-500"
                                     :class="usagePercent > 90 ? 'bg-red-500' : usagePercent > 70 ? 'bg-yellow-500' : 'bg-blue-500'"
                                     :style="'width: ' + usagePercent + '%'"></div>
                            </div>
                        </div>
                    </div>
                    <!-- ▲▲▲ KPIカード End ▲▲▲ -->

                    <!-- ▼▼▼ アプリ別利用状況テーブル ▼▼▼ -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                            <h2 class="text-base font-bold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-robot text-gray-400"></i> アプリ別利用状況
                            </h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-100">
                                    <tr>
                                        <th class="px-6 py-3 font-medium">Difyアプリ</th>
                                        <th class="px-6 py-3 font-medium w-1/2">利用状況 (実績 / 上限)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="usage in appUsages" :key="usage.id">
                                        <tr class="hover:bg-gray-50/50 transition-colors"
                                            :class="{ 'bg-red-50 hover:bg-red-100': usage.count > usage.limit }">
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="h-9 w-9 rounded-lg flex items-center justify-center flex-shrink-0"
                                                         :class="'bg-' + usage.appColor + '-100 text-' + usage.appColor + '-600'">
                                                        <i class="fas" :class="usage.appIcon"></i>
                                                    </div>
                                                    <span class="font-medium text-gray-900" x-text="usage.app"></span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="max-w-xs">
                                                    <div class="flex justify-between items-end mb-1">
                                                        <span class="text-sm font-bold"
                                                              :class="usage.count > usage.limit ? 'text-red-600' : 'text-gray-900'"
                                                              x-text="usage.count.toLocaleString() + ' 回'"></span>
                                                        <span class="text-xs text-gray-400" x-text="'/ ' + usage.limit.toLocaleString()"></span>
                                                    </div>
                                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                                        <div class="h-2 rounded-full transition-all duration-500"
                                                             :class="getProgressColor(usage.count, usage.limit)"
                                                             :style="'width: ' + getPercentage(usage.count, usage.limit) + '%'">
                                                        </div>
                                                    </div>
                                                    <p class="text-xs text-gray-400 mt-1 text-right"
                                                       x-text="getPercentage(usage.count, usage.limit) + '%'"></p>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>

                                    <!-- Empty State -->
                                    <tr x-show="appUsages.length === 0">
                                        <td colspan="2" class="px-6 py-12 text-center text-gray-500">
                                            <i class="fas fa-inbox mb-2 text-2xl text-gray-300"></i>
                                            <p>今月の利用データはありません。</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer -->
                        <div class="px-6 py-3 bg-gray-50 border-t border-gray-100">
                            <p class="text-xs text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                利用状況は数分遅延する場合があります。上限超過時はAPIリクエストが拒否されます。
                            </p>
                        </div>
                    </div>
                    <!-- ▲▲▲ アプリ別利用状況テーブル End ▲▲▲ -->

                </div>

            </main>
        </div>
    </div>

</body>
</html>
