# **Dify中継・管理プラットフォーム 要件定義書** 

## **1\. プロジェクト概要**

オンプレミスシステムとDify（LLMプラットフォーム）の中間に位置し、リクエストの認証、中継、利用状況の管理を行うゲートウェイシステムを構築する。

**Laravel 12 \+ Jetstream** を基盤とし、拠点ごとの固定APIキー認証、契約プランに基づく月間リクエスト制限、およびDifyアプリ（ワークフロー）ごとの接続先管理を実現する。

### **1.1 技術スタック**

* **Framework:** **Laravel 12.x**
* **Frontend:** Livewire 4.x (Jetstream Stack)
* **Auth Scaffolding:** Laravel Jetstream (Teams機能 **有効**)
* **HTTP Client:** Laravel Http Facade (for Dify Proxy)
* **Database:** PostgreSQL 16+

## **2\. システムアーキテクチャ**

### **2.1 認証・権限モデル（ハイブリッド構成）**

* **管理者 (Admin):**
  * users テーブルの is\_admin フラグで管理。
  * 管理画面への全アクセス権限を持つ。**URLパスは固定の /admin ではなく、環境変数等で変更可能な推測されにくい文字列とする。**
  * **二段階認証（メールOTP）:** 管理者ログイン時のみ、メールアドレスとパスワード認証後に、メールで送信された6桁のOTPコードの入力を必須とする。
* **一般ユーザー (拠点担当者):**
  * is\_admin \= false のユーザー。各拠点（Team）に所属する担当者。
  * ブラウザからログインし、自身のチームの利用状況（ダッシュボード）のみを閲覧できる。管理者機能や設定変更は不可。
  * 二段階認証は不要（通常のメールアドレス/パスワード認証のみ）。
* **拠点 (Team) \- API利用:**
  * オンプレミスの各拠点。team\_api\_keys テーブルの固定キー (X-Api-Key) で認証する。
  * システム内部では、キーに紐づくTeamの管理者(Owner)として振る舞う。
* **個人 (User) \- 将来の拡張:**
  * 将来的な個人端末利用に備え、Laravel Sanctumの準備（パッケージ導入・Model設定）のみ完了させておく。現時点の認証ガードには適用しない。

### **2.2 Dify中継モデル (Proxy)**

* **識別:** URLパスに含まれる **"Slug"** (例: sales-bot) で接続先のDifyアプリを特定する。  
* **認証差替:** オンプレからの X-Api-Key を検証後、Dify用の Authorization: Bearer \<Dify-Key\> に差し替えて転送する。  
* **通信方式:** ブロッキング（非ストリーミング）。Difyからのレスポンスを待ってからオンプレへ返す。

## **3\. データベース設計**

### **① users (拡張)**

| Column | Type | Note |
| :---- | :---- | :---- |
| ... | ... | (Jetstream standard columns) |
| is\_admin | boolean | Default: false. trueなら管理者 |

### **② teams (拡張)**

拠点（契約主体）管理。

| Column | Type | Note |
| :---- | :---- | :---- |
| ... | ... | (Jetstream standard columns) |
| plan\_id | FK | plans.id (Nullable) |

### **③ team\_api\_keys (拠点認証用)**

拠点がLaravelにアクセスするための固定キー。高速認証と復元表示を両立する。

| Column | Type | Note |
| :---- | :---- | :---- |
| id | PK |  |
| team\_id | FK | teams.id |
| name | string | 識別名 (例: Gateway\_01) |
| key\_hash | string | **認証用 (SHA-256ハッシュ)**。Index。 |
| key\_encrypted | text | **表示・復元用 (Laravel Encrypt)**。 |
| last\_used\_at | timestamp | 最終利用日時 |

### **④ dify\_apps (中継先設定)**

Dify側のアプリ情報。

| Column | Type | Note |
| :---- | :---- | :---- |
| id | PK |  |
| name | string | アプリ名 (例: 翻訳Bot) |
| slug | string | **URL識別子** (unique, 例: translator) |
| api\_key | text | **Dify API Key (暗号化保存)** |
| is\_active | boolean | Default: true |

### **⑤ plans, plan\_limits (制限設定)**

**plans (プラン定義)**

| Column | Type | Note |
| :---- | :---- | :---- |
| id | PK |  |
| name | string | プラン名 (例: Light, Standard) |
| code | string | 識別コード (unique, 例: light) |

**plan\_limits (エンドポイントごとの上限)**

| Column | Type | Note |
| :---- | :---- | :---- |
| id | PK |  |
| plan\_id | FK | plans.id |
| endpoint | string | URLパターン (例: /relay/translator/v1/chat-messages) |
| limit\_count | integer | 月間許容回数 |

### **⑥ monthly\_api\_usages (ログ・制限実績)**

メタデータのみ保存（プロンプト中身は保存しない）。月次リセット不要の自動切替方式。

| Column | Type | Note |
| :---- | :---- | :---- |
| id | PK |  |
| team\_id | FK | teams.id |
| endpoint | string | 対象URI (例: /relay/sales-bot/...) |
| dify\_app\_id | FK | dify\_apps.id (Nullable) |
| year\_month | string | "YYYY-MM" |
| request\_count | integer | 利用回数 (Accumulated) |
| tokens\_consumed | integer | (Optional) Difyレスポンス内のtoken数 |

* **Unique Index:** \[team\_id, endpoint, year\_month\]

## **4\. 機能要件：API & Dify中継**

### **4.1 エンドポイント仕様**

* **URL:** POST /relay/{slug}/{any}  
  * slug: dify\_apps テーブルを検索するキー。  
  * any: Dify APIのパス (例: v1/chat-messages, v1/workflows/run)。  
* **Headers:**  
  * X-Api-Key: 拠点認証キー。  
  * Content-Type: application/json

### **4.2 認証ミドルウェア (AuthenticateHybrid)**

1. **Sanctumチェック:** Bearer Token があればSanctum認証を試行（将来用）。  
2. **APIキーチェック:** なければ X-Api-Key をSHA-256ハッシュ化し、team\_api\_keys.key\_hash を検索。  
3. **代理ログイン:** ヒットした場合、そのTeamのOwnerとしてログイン状態にし、currentTeam を設定する。

### **4.3 中継ロジック (DifyProxyController \+ CheckMonthlyQuota)**

1. **制限チェック:**  
   * 現在のTeamのPlanとURLに基づき plan\_limits (上限) を取得。  
   * monthly\_api\_usages (実績) を year\_month (現在) で検索・新規作成。  
   * 実績 \>= 上限 なら 429 Too Many Requests エラーを返却。  
2. **転送準備:**  
   * URLの slug から dify\_apps を特定し、Difyキーを復号する。  
3. **リクエスト転送:**  
   * 接続先: Dify基底URL \+ /{any}  
   * ヘッダー: Authorization: Bearer \<Decrypted Dify Key\>  
   * ボディ: オンプレからのJSONをパースし、user フィールドの値を認証済みTeamの名称(teams.name)に置換して転送する（Dify側での識別用）。  
4. **レスポンス:** Difyからの応答をそのままオンプレへ返却。  
5. **ログ更新:** monthly\_api\_usages のカウントをインクリメント。

## **5\. 機能要件：管理者機能 (Custom Path)**

AdminGuard ミドルウェアで保護されたエリア。

**セキュリティ向上のため、URLプレフィックスは /admin 固定ではなく、環境変数（例: ADMIN\_PATH）等で任意の推測されにくい文字列（例: /secret\_manage\_x9z）に変更可能とする。**

### **5.1 拠点・ユーザー管理**

* ユーザー/チームの一覧・作成・編集。  
  * **検索機能:** ユーザー名、メールアドレス、チーム名での絞り込み検索・キーワード検索を実装する。  
* **チーム詳細・編集機能:**  
  * チーム名、契約プランの変更。  
  * **APIキー管理セクション:** チーム編集画面内に配置する。  
    * **復号表示:** key\_encrypted を復号して、平文のキーを表示する（「\*\*\*\*\*」マスク解除）。  
    * **再発行(上書き):** 管理者が任意の文字列を入力し、キー情報を更新する（ハッシュと暗号化の両方を更新）。  
* **CSV一括登録（拠点開設）:**  
  * フォーマット: UserEmail, Password, TeamName, PlanCode, ApiKeyName, FixedApiKey(Optional)  
  * 処理: 1行ごとにトランザクションを張り、ユーザー作成 \-\> チーム作成 \-\> プラン紐付け \-\> 固定APIキー登録を行う。

### **5.2 Difyアプリ管理**

* dify\_apps テーブルの CRUD。スラッグ設定、Dify APIキー登録（暗号化）。  
  * **検索機能:** アプリ名、スラッグでの絞り込み検索を実装する。

### **5.3 利用状況管理**

* チームごとの月間利用回数の一覧。  
  * **検索機能:** チーム名、年月、Difyアプリ名での絞り込み検索を実装する。  
* **編集機能:** monthly\_api\_usages の request\_count を管理者が手動で修正できる機能（誤カウント訂正用）。

### **5.4 災害復旧データ管理 (DR Export)**

サーバーデータ消失に備え、構成管理をGitで行うための機能。

* **エクスポート機能:**
  * 管理画面に「復旧用データ出力」ボタンを設置。
  * 現在の全ユーザー、チーム、プラン紐付け、**固定APIキー（復号済み平文）** を含むJSONファイルを生成し、ダウンロードさせる。
* **運用フロー:**
  1. **日常:** 管理画面からユーザー登録・即時利用開始。
  2. **バックアップ:** 定期的にエクスポートし、JSONをGitリポジトリ（database/seeders/data/teams.json）にコミットする。

### **5.5 二段階認証（管理者ログイン時のみ）**

管理者（is\_admin \= true）のログイン時のみ、メールベースのOTP（One-Time Password）による二段階認証を実施する。

#### **5.5.1 認証フロー**

1. **第一段階:** メールアドレス・パスワードでログイン試行（Laravel Fortify標準）。
2. **認証成功後:**
   * ユーザーが is\_admin \= true の場合のみ、セッションに「二段階認証待ち」フラグを設定。
   * 6桁のOTPコードを生成（数字のみ、有効期限10分）。
   * コードをデータベース（two\_factor\_tokens テーブル）に保存。
   * **OTPコードをユーザーID=1の管理者のメールアドレスにのみ送信。**
   * 二段階認証コード入力画面（G02）へリダイレクト。
3. **一般ユーザーの場合:** 二段階認証をスキップし、通常通りダッシュボード（U01）へリダイレクト。

**注記:** どの管理者がログインしようとした場合でも、OTPコードは常にユーザーID=1（スーパー管理者）のメールアドレスにのみ送信される。これにより、すべての管理者ログイン試行を一元管理できる。

#### **5.5.2 OTPコード検証**

* **入力画面:** G02で6桁のコードを入力。
* **検証:**
  * データベースのトークンと照合。
  * 有効期限（10分）を確認。
  * 最大試行回数（5回）を超えた場合はトークンを無効化し、ログアウト。
* **成功時:** セッションを確立し、管理者ダッシュボード（A01）へリダイレクト。
* **失敗時:** エラーメッセージを表示し、再入力を促す。

#### **5.5.3 データベース設計**

**two\_factor\_tokens テーブル**

| Column | Type | Note |
| :---- | :---- | :---- |
| id | PK |  |
| user\_id | FK | users.id |
| token | string | 6桁のOTPコード（ハッシュ化せず平文保存） |
| expires\_at | timestamp | 有効期限（生成時刻 + 10分） |
| attempts | integer | 試行回数（デフォルト: 0、最大: 5） |
| created\_at | timestamp | 生成日時 |

* **Unique Index:** \[user\_id\]（同一ユーザーは1つのトークンのみ保持）

#### **5.5.4 メール通知**

**送信先:** ユーザーID=1の管理者のメールアドレス（固定）

**件名:** `[rasinban-ai-studio] 管理者ログイン - 二段階認証コード`

**本文:**
```
{ユーザーID=1の管理者名} 様

管理者ログインの二段階認証コードをお送りします。

【ログイン試行者】
ユーザーID: {ログイン試行者のID}
ユーザー名: {ログイン試行者の名前}
メールアドレス: {ログイン試行者のメールアドレス}

【認証コード】
{OTPコード}

このコードは10分間有効です。
ログイン画面でコードを入力してログインを完了してください。

※このログイン試行に心当たりがない場合は、不正アクセスの可能性があります。速やかにパスワードを変更してください。
```

**注記:** メールにはログイン試行者の情報（ID、名前、メールアドレス）を含めることで、ユーザーID=1の管理者がどの管理者アカウントがログインを試行したかを確認できる。

#### **5.5.5 セキュリティ仕様**

* **対象:** 管理者（is\_admin \= true）のみ。一般ユーザーは二段階認証不要。
* **トークン再発行:** 同一ユーザーが再度ログインした場合、既存のトークンを削除して新しいトークンを生成。
* **試行回数制限:** 5回連続で間違えた場合、トークンを無効化し、ログアウト（再度ログインから開始）。
* **有効期限:** 10分（expires\_at を超えたトークンは無効）。
* **自動クリーンアップ:** 有効期限切れのトークンは定期的に削除（Artisanコマンドまたはスケジューラー）。

## **6\. 機能要件：一般ユーザー機能（拠点担当者）**

管理者ではない一般ユーザー（is\_admin \= false）向けのブラウザ機能。

### **6.1 ログイン**

* /login 画面からメールアドレス・パスワードでログイン可能。  
* ログイン後は、自身の所属するチームのダッシュボードへ遷移する。  
* **制限:** 管理者画面（環境変数で設定されたカスタムパス）へはアクセス不可（403 Forbidden）。

### **6.2 ダッシュボード (利用状況確認)**

* **概要:** 自身のチーム（currentTeam）のAPI利用状況を可視化し、閲覧のみ可能とする（編集不可）。  
* **表示項目:**  
  * **契約プラン情報:** 現在のプラン名、プランごとの月間リクエスト上限数。  
  * **Difyアプリ別利用状況:**  
    * アプリ名（エンドポイントスラッグ）。  
    * 今月の利用回数 / 上限回数。  
    * 進捗バー（利用率）。  
    * 残り利用可能回数。

## **7\. 機能要件：災害復旧 (DR Restore)**

### **7.1 OnPremiseSetupSeeder**

サーバーデータ消失時の復旧用シーダー。

* **データソース:** リポジトリ内のJSONファイル (database/seeders/data/teams.json) を読み込む。  
* **ロジック:** updateOrCreate を使用し、何度実行しても重複しない**冪等性**を担保する。  
* **処理:**  
  1. 不足しているチーム・ユーザーを作成。  
  2. JSON内の固定キー(平文)を、「ハッシュ化(検索用)」と「暗号化(表示用)」の両方に変換して保存。

## **8\. 実装ステップ（AI/開発者への指示）**

1. **環境構築:**  
   * Laravel 12 \+ Jetstream (Livewire/Teams) インストール。  
   * Sanctum準備（インストール確認、Userモデルへの HasApiTokens 追加）。  
2. **DB構築:**  
   * マイグレーション (dify\_apps, team\_api\_keys with encryption cols, monthly\_api\_usages etc.)。  
3. **Auth実装:**  
   * AuthenticateHybrid: 固定キー認証 (Hash検索) \+ Sanctumガード。  
   * AdminGuard: is\_admin チェック。  
4. **Admin機能:**  
   * **セキュリティ:** 管理者ルートのプレフィックスを環境変数から取得するように設定。  
   * CSVインポート、Difyアプリ管理、APIキー管理(Enc/Dec)。  
   * **検索機能:** 各一覧画面への検索・絞り込み機能の実装。  
   * **復旧データエクスポート機能**の実装。  
5. **一般ユーザー機能:**  
   * 一般ユーザー用ダッシュボード（利用状況表示コンポーネント）の実装。  
6. **Seeder実装:** DR対策用シーダー（JSON読込対応）。  
7. **Proxy実装:**  
   * DifyProxyController: スラッグ解決 & 転送ロジック。  
   * CheckMonthlyQuota: メタデータログ記録 & 制限。  
   * **JSON改変処理:** user フィールドの置換ロジック実装。