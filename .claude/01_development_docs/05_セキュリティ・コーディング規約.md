# セキュリティ・コーディング規約

## 概要

このドキュメントは、rasinban-ai-studioプロジェクトにおけるセキュリティ対策とコーディング規約を定義します。特に、一般ユーザーエリアでのデータアクセス制御について重点的に記載します。

---

## 1. データアクセス制御の基本方針

### 1.1 URL設計による防御（第一防御線）

**原則:** 一般ユーザーエリアのURLには、**team_id を絶対に含めない**

#### ✅ 正しいURL設計

```php
// 一般ユーザーエリア
Route::get('/dashboard', UserDashboard::class)->name('user.dashboard');

// URLに team_id を含めない
// ログインユーザーの所属チーム（current_team_id）を自動取得
```

#### ❌ 間違ったURL設計

```php
// ❌ BAD: team_id をURLパラメータに含める（改ざんリスク）
Route::get('/teams/{team}/dashboard', [...]);
Route::get('/dashboard', [...]) // ?team_id=5 のようなクエリパラメータも禁止
```

**理由:**
- URLに`team_id`がなければ、改ざんのしようがない
- シンプルで安全、管理も容易

---

## 2. 一般ユーザーエリアのコーディング規約

### 2.1 禁止事項【重要】

以下のコードパターンは一般ユーザーエリアで**絶対に使用禁止**：

#### ❌ 禁止パターン1: リクエストからteam_idを受け取る

```php
// ❌ BAD: リクエストパラメータからteam_idを取得（脆弱性）
$teamId = request()->input('team_id');
$teamId = $request->get('team_id');
$teamId = $request->query('team_id');
```

#### ❌ 禁止パターン2: Team::find() の直接使用

```php
// ❌ BAD: IDを指定してTeamを取得（他チームのデータ取得リスク）
$team = Team::find($teamId);
$team = Team::findOrFail($teamId);
```

#### ❌ 禁止パターン3: URLパラメータでのteam_id受け渡し

```php
// ❌ BAD: ルート定義にteam_idを含める
Route::get('/teams/{team}/dashboard', [...]);

// ❌ BAD: クエリパラメータでteam_idを渡す
redirect('/dashboard?team_id=' . $teamId);
```

### 2.2 必須事項【重要】

一般ユーザーエリアでは、以下のパターンを**必ず使用**：

#### ✅ 必須パターン1: auth()->user()->currentTeam を使用

```php
// ✅ GOOD: 認証ユーザーの所属チームを自動取得
$team = auth()->user()->currentTeam;

// Livewire コンポーネント内
public function render()
{
    $team = auth()->user()->currentTeam;

    $usages = $team->monthlyUsages()
        ->latest()
        ->paginate(10);

    return view('livewire.user.dashboard', compact('team', 'usages'));
}
```

#### ✅ 必須パターン2: リレーションを活用

```php
// ✅ GOOD: リレーション経由でデータ取得（自動的に所属チームのみ）
$usages = auth()->user()->currentTeam->monthlyUsages()
    ->with('difyApp')
    ->latest()
    ->get();

// ✅ GOOD: Eloquentリレーションで安全に取得
$currentTeam = auth()->user()->currentTeam;
$apiKeys = $currentTeam->apiKeys;
$members = $currentTeam->users;
```

#### ✅ 必須パターン3: where条件で明示的にフィルタ（リレーション不使用時）

```php
// ✅ GOOD: 必ず current_team_id でフィルタ
$usages = MonthlyApiUsage::where('team_id', auth()->user()->current_team_id)
    ->latest()
    ->get();
```

---

## 3. 管理者エリアとの違い

### 3.1 管理者エリア（A01-A09）

管理者は**全チームのデータにアクセス可能**なため、URLに`{team}`を含めてOK。

```php
// ✅ 管理者エリアではOK
Route::middleware(['auth', 'admin'])->prefix('admin')->group(function () {
    Route::get('/teams/{team}', TeamEdit::class)->name('admin.teams.edit');
    Route::get('/teams/{team}/users', TeamUsers::class);
});

// Livewire コンポーネント
class TeamEdit extends Component
{
    public Team $team; // ルートバインディングでOK

    public function mount(Team $team)
    {
        $this->team = $team; // 管理者なので全チームアクセス可能
    }
}
```

**理由:**
- `AdminGuard` ミドルウェアで `is_admin` チェック済み
- 管理者は業務上、全チームのデータを扱う必要がある

### 3.2 一般ユーザーエリア（U01等）

一般ユーザーは**自分の所属チームのみ**アクセス可能。

```php
// ✅ 一般ユーザーエリア
Route::middleware(['auth', 'verified'])->group(function () {
    Route::get('/dashboard', UserDashboard::class)->name('user.dashboard');
    // team_id を含めない
});

// Livewire コンポーネント
class UserDashboard extends Component
{
    public function render()
    {
        // 必ず auth()->user()->currentTeam を使用
        $team = auth()->user()->currentTeam;

        $usages = $team->monthlyUsages()
            ->latest()
            ->paginate(10);

        return view('livewire.user.dashboard', compact('team', 'usages'));
    }
}
```

---

## 4. セキュリティチェックリスト

### 4.1 コードレビュー時の確認項目

一般ユーザーエリアのコードレビューでは、以下を必ず確認：

- [ ] URLに`team_id`パラメータが含まれていないか？
- [ ] `request()->input('team_id')` を使用していないか？
- [ ] `Team::find($id)` を直接使用していないか？
- [ ] 必ず `auth()->user()->currentTeam` を使用しているか？
- [ ] クエリに `where('team_id', auth()->user()->current_team_id)` フィルタがあるか？

### 4.2 プルリクエスト時のチェック

```markdown
## セキュリティチェック（一般ユーザーエリアのみ）

- [ ] URLに team_id を含めていない
- [ ] auth()->user()->currentTeam を使用している
- [ ] リクエストパラメータから team_id を取得していない
- [ ] Team::find() を直接使用していない
```

---

## 5. テスト方針

### 5.1 必須テスト項目

一般ユーザーエリアでは、以下のテストを必ず実装：

```php
// tests/Feature/UserDashboardTest.php

/** @test */
public function 一般ユーザーは自分の所属チームのデータのみ表示される()
{
    $user = User::factory()->create(['is_admin' => false]);
    $team = Team::factory()->create();
    $user->current_team_id = $team->id;
    $user->save();

    $this->actingAs($user)
        ->get('/dashboard')
        ->assertOk()
        ->assertSee($team->name);
}

/** @test */
public function URLにteam_idパラメータがあっても無視される()
{
    $user = User::factory()->create(['is_admin' => false]);
    $myTeam = Team::factory()->create(['name' => 'My Team']);
    $otherTeam = Team::factory()->create(['name' => 'Other Team']);

    $user->current_team_id = $myTeam->id;
    $user->save();

    // 他のチームIDをパラメータで渡してもアクセスできない
    $this->actingAs($user)
        ->get('/dashboard?team_id=' . $otherTeam->id)
        ->assertOk()
        ->assertSee('My Team')
        ->assertDontSee('Other Team');
}
```

---

## 6. よくある質問（FAQ）

### Q1: Policyは使わないのですか？

**A:** 一般ユーザーエリアでは不要です。

- URL設計で`team_id`を含めないため、そもそも他チームのデータにアクセスできない
- `auth()->user()->currentTeam`を使えば、自動的に所属チームのみ取得される
- Policyを使うと、毎回`$this->authorize()`を書く必要があり、**書き忘れのリスク**がある

管理者エリアで、特定のチーム操作を制限したい場合にのみPolicyを使用してください。

### Q2: カスタムミドルウェアは必要ないですか？

**A:** 基本的に不要です。

- コーディング規約を守れば、自然と安全なコードになる
- コードレビューで十分防げる

どうしても心配な場合のみ、リクエストに`team_id`があったら弾く軽量ミドルウェアを追加してください（オプション）。

### Q3: 管理者が一般ユーザーエリアにアクセスした場合は？

**A:** 管理者も`current_team_id`を持っているため、問題ありません。

- 管理者が`/dashboard`にアクセス → 自分の`current_team_id`のチームデータが表示される
- 管理者が全チームを見たい場合は、管理者エリア（`/admin/teams`）を使用する

### Q4: Jetstreamのcurrent_team_idは変更できますか？

**A:** はい、変更可能です。

- Jetstreamの標準機能で、ユーザーは複数チームに所属し、`current_team_id`を切り替えられる
- 一般ユーザーが所属チームを切り替えた場合、ダッシュボードの表示も自動的に変わる
- セキュリティ上も問題なし（あくまで自分の所属チーム内での切り替え）

---

## 7. まとめ

### 7.1 シンプルで安全な設計

```
一般ユーザーエリアのセキュリティ = URL設計 + コーディング規約
```

- **URL設計:** team_idを含めない（第一防御線）
- **コーディング規約:** `auth()->user()->currentTeam`を使う（第二防御線）
- **コードレビュー:** 規約違反をチェック（第三防御線）

### 7.2 管理を煩雑にしない

- ❌ Policy不要
- ❌ カスタムミドルウェア不要（基本）
- ❌ 毎回`authorize()`を書く必要なし
- ✅ シンプルなURL設計だけで解決
- ✅ `auth()->user()->currentTeam`を使うだけ
- ✅ 保守性が高い

### 7.3 開発フロー

1. **ルート定義:** team_idを含めない
2. **Livewire実装:** `auth()->user()->currentTeam`を使う
3. **コードレビュー:** チェックリストで確認
4. **テスト:** 所属チームのデータのみ表示されることを確認

---

## 8. 参考リンク

- [Laravel Jetstream - Teams](https://jetstream.laravel.com/features/teams.html)
- [Laravel Authentication](https://laravel.com/docs/12.x/authentication)
- [Eloquent Relationships](https://laravel.com/docs/12.x/eloquent-relationships)
