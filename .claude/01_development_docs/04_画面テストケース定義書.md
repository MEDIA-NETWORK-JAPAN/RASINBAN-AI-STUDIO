# 画面テストケース定義書

## 1. 概要

### 1.1 ドキュメントの目的

本ドキュメントは、rasinban-ai-studioプロジェクトにおける **画面単位（Feature Test）** の受入条件とテストケースを定義します。

### 1.2 対象範囲

- **対象画面:** 管理者エリア（A01-A09）、一般ユーザーエリア（U01）、共通画面（G01）
- **テストアプローチ:** Feature Test（統合テスト）+ E2Eシナリオテスト
- **テスト対象:**
  - ページの表示・レンダリング
  - データの取得・表示
  - フォーム送信・バリデーション
  - 認証・認可
  - 画面遷移
  - Livewireインタラクション
  - データベース操作
  - ビジネスロジック

- **テスト対象外:**
  - ブラウザの詳細なUI/UXテスト（Duskで将来対応）
  - パフォーマンステスト
  - セキュリティ脆弱性スキャン

### 1.3 総テストケース数

- **総ケース数:** 150ケース（全12画面）
- **優先度別内訳:**
  - **High:** 146ケース（97.3%）- 主要機能、クリティカルパス、認証・認可
  - **Medium:** 4ケース（2.7%）- エッジケース、視覚的確認
  - **Low:** 0ケース（0%）

**画面別ケース数:**
- A01: 管理者ダッシュボード（12ケース）
- A02: 拠点一覧（17ケース）
- A03: 拠点編集（17ケース）
- A04: CSV一括登録（19ケース）
- A05: Difyアプリ一覧（12ケース）
- A06: Difyアプリ編集（13ケース）
- A07: 利用状況一覧（23ケース）
- A08: 利用回数修正（4ケース）
- A09: 災害復旧エクスポート（9ケース）
- U01: 拠点ダッシュボード（5ケース）
- G01: ログイン（5ケース）
- G02: 二段階認証（13ケース）

### 1.4 コンポーネントテストとの関係

- **コンポーネントテスト（03_テストケース定義書.md）:** UI部品単体の動作検証
- **画面テスト（本ドキュメント）:** ビジネスロジック、データフロー、画面全体の統合検証

両方のテストが必要で、相互に補完関係にあります。

---

## 2. テスト戦略

### 2.1 テストアプローチ

各画面に対して **Feature Test（統合テスト）** を実施します。

#### テスト種別

1. **認証・認可テスト**
   - ログイン状態の検証
   - 管理者/一般ユーザーの権限検証
   - 未認証時のリダイレクト

2. **ページ表示テスト**
   - HTTPステータス200の確認
   - 必須要素の表示確認
   - データの正しい表示

3. **データ操作テスト（CRUD）**
   - Create: フォーム送信、データ登録
   - Read: データ取得、一覧表示
   - Update: データ更新、バリデーション
   - Delete: データ削除、確認モーダル

4. **検索・フィルタテスト**
   - 検索機能の動作
   - フィルタの適用
   - ページネーション

5. **Livewireインタラクションテスト**
   - リアルタイム検索
   - モーダル開閉
   - 状態変更

6. **ビジネスロジックテスト**
   - APIキー生成
   - 利用回数制限
   - 月次集計

### 2.2 優先度付け

| 優先度 | 条件 | 実装タイミング |
|--------|------|--------------|
| **High** | 主要機能、ユーザーが頻繁に使用、データ整合性が重要 | Phase 1（Week 1-3） |
| **Medium** | サブ機能、エラーハンドリング、エッジケース | Phase 2（Week 4-6） |
| **Low** | 将来的な拡張、詳細な検証 | Phase 3（Week 7-8） |

### 2.3 実装フロー

1. **Phase 1（High優先度）:** A01, A02, A03, A05（基本CRUD画面）
2. **Phase 2（Medium優先度）:** A04, A06, A07, A09（特殊機能画面）
3. **Phase 3（Low優先度）:** A08, U01, G01（モーダル、一般ユーザー、ログイン）

---

## 3. テスト環境

### 3.1 テストフレームワーク

- **PHPUnit:** 11.5.3
- **Laravel Testing:** Laravel 12.x Testing Utilities
- **Livewire Testing:** Livewire 4.x組み込み
- **Database Testing:** RefreshDatabase trait

### 3.2 テスト実行コマンド

```bash
# 全画面テスト実行
vendor/bin/sail artisan test --compact tests/Feature/Screens

# 特定画面のみ実行
vendor/bin/sail artisan test --compact tests/Feature/Screens/A01AdminDashboardTest.php

# 特定テスト名でフィルタ
vendor/bin/sail artisan test --compact --filter=testCanViewDashboard
```

### 3.3 テストデータ準備

- **Seeders:** テスト用の基本データ（Plans, Users, Teams）
- **Factories:** 動的なテストデータ生成
- **RefreshDatabase:** 各テスト後にDBをリセット

---

## 4. 受入条件（Acceptance Criteria）

### 4.1 受入条件テンプレート

各画面の受入条件を以下のカテゴリに分けて定義：

1. **AC1: 認証・認可** - ログイン状態、権限検証
2. **AC2: ページ表示** - 基本表示、データ表示
3. **AC3: データ操作（CRUD）** - 登録、更新、削除
4. **AC4: 検索・フィルタ** - 検索機能、フィルタリング
5. **AC5: Livewireインタラクション** - リアルタイム更新、モーダル
6. **AC6: ビジネスロジック** - 計算、集計、バリデーション
7. **AC7: エラーハンドリング** - バリデーションエラー、例外処理

### 4.2 AC-IDの採番ルール

**形式:** `AC-{画面ID}-{カテゴリ番号}{連番}`

**カテゴリ番号:**
- 0xx: 認証・認可
- 1xx: ページ表示
- 2xx: データ操作（CRUD）
- 3xx: 検索・フィルタ
- 4xx: Livewireインタラクション
- 5xx: ビジネスロジック
- 6xx: エラーハンドリング

**例:** `AC-A01-001`, `AC-A02-101`, `AC-A03-201`

### 4.3 カテゴリ別受入条件

---

#### 4.3.1 A01: 管理者ダッシュボード

**概要:**
管理者がログイン後に最初にアクセスする画面。システム全体の稼働状況を俯瞰。URL: `/admin`

**受入条件:**

##### AC1: 認証・認可
- AC-A01-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A01-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A01-003: 管理者ユーザー（is_admin=true）がアクセスした場合、ダッシュボードが表示される【High】

##### AC2: ページ表示
- AC-A01-101: KPIカードエリアに「契約拠点数」「今月の総リクエスト」「稼働Difyアプリ」が表示される【High】
- AC-A01-102: 契約拠点数に `teams.count()` の値が表示される【High】
- AC-A01-103: 今月の総リクエストに `monthly_api_usages.sum('count')` の値が表示される【High】
- AC-A01-104: 稼働Difyアプリに `dify_apps.where('is_active', true).count()` の値が表示される【High】
- AC-A01-105: 利用率の高いユーザー一覧テーブルに上位5件が表示される（ユーザー名・拠点名・プラン・利用率を含む）【High】
- AC-A01-106: 各ユーザーの利用率がプログレスバーとパーセンテージで表示される【Medium】

##### AC3: データ操作
- AC-A01-201: 編集ボタンをクリックした場合、A03拠点編集画面（`/admin/teams/{id}`）へ遷移する【High】
- AC-A01-202: 「すべて見る」リンクをクリックした場合、A07利用状況一覧画面（`/admin/usages`）へ遷移する【Medium】

##### AC5: ビジネスロジック
- AC-A01-501: 利用率の計算が正しい（`usage_count / usage_limit * 100`）【High】
- AC-A01-502: 利用率が90%以上のユーザーのプログレスバーが赤色で表示される【Medium】

---

#### 4.3.2 A02: 拠点一覧

**概要:**
登録されている拠点（Team）の一覧表示、検索、新規作成を行う画面。URL: `/admin/teams`

**受入条件:**

##### AC1: 認証・認可
- AC-A02-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A02-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A02-003: 管理者ユーザー（is_admin=true）がアクセスした場合、拠点一覧が表示される【High】

##### AC2: ページ表示
- AC-A02-101: 拠点一覧テーブルに全拠点が表示される（ページネーション: 50件/ページ）【High】
- AC-A02-102: 各拠点に「拠点名」「管理者（メールアドレス）」「最終アクセス」が表示される（プランはユーザー単位のためテーブル列から削除）【High】
- AC-A02-105: 管理者カラムにオーナー名とメールアドレス（グレー表示）が表示される【High】
- AC-A02-106: 最終アクセスカラムに相対時刻が表示される（例: 2時間前、1日前）【Medium】
- AC-A02-107: 検索バー（拠点名で検索、debounce 300ms）が表示される【High】
- AC-A02-108: 制限超過フィルタ（ToggleSwitch、ONで制限超過拠点のみ表示）が表示される【High】

##### AC3: データ操作（CRUD）
- AC-A02-201: 「新規作成」ボタンをクリックした場合、新規作成モーダルが表示される【High】
- AC-A02-202: モーダル表示時、管理者ユーザーのAPIキーが自動生成される（64文字のランダム文字列）【High】
- AC-A02-203: モーダルのAPIキー再生成ボタンをクリックした場合、新しいAPIキーが生成される【Medium】
- AC-A02-204: モーダルで拠点名、管理者名、管理者メール、初期パスワード、プラン（管理者ユーザー用）、APIキー（自動生成済み）を確認して保存した場合、Team・管理者User・UserApiKeyが作成される【High】
- AC-A02-205: モーダルでバリデーションエラーがある場合、エラーメッセージが表示される【High】
- AC-A02-206: 拠点作成後、モーダルが閉じ、一覧が更新される【High】
- AC-A02-207: 拠点名（セル）をクリックした場合、A03拠点編集画面（`/admin/teams/{id}`）へ遷移する【High】

##### AC4: 検索・フィルタ
- AC-A02-301: 検索バーに拠点名を入力した場合、部分一致で拠点が絞り込まれる（debounce 300ms、`wire:model.live.debounce.300ms`）【High】
- AC-A02-303: 制限超過フィルタ（ToggleSwitch）をONにした場合、`total_requests > plan_limits.monthly_limit` の拠点のみ表示される【High】
- AC-A02-305: 検索とフィルタを組み合わせた場合、AND条件で絞り込まれる【Medium】
- AC-A02-306: ページネーションをクリックした場合、次のページ（50件単位）が表示される【High】
- AC-A02-307: 検索またはフィルタ実行時、ページネーションが1ページ目にリセットされる【High】

##### AC5: Livewireインタラクション
- AC-A02-401: 検索入力中、debounce 300ms後にリアルタイムで一覧が更新される【High】
- AC-A02-402: 制限超過フィルタ（ToggleSwitch）をON/OFF切替した場合、即時フィルタリングが更新される【High】
- AC-A02-403: モーダルを開閉した場合、フォームがリセットされる【Medium】
- AC-A02-404: モーダルのAPIキー再生成ボタンをクリックした場合、`Str::random(64)` で新しいAPIキーが生成される【Medium】

##### AC6: ビジネスロジック
- AC-A02-501: 利用率100%超過の拠点のプログレスバーが赤色（`bg-red-600`）で表示される【High】
- AC-A02-502: 利用率90%以上の拠点のプログレスバーが黄色（`bg-yellow-500`）で表示される【Medium】
- AC-A02-503: 利用率90%未満の拠点のプログレスバーが青色（`bg-blue-500`）で表示される【Medium】
- AC-A02-504: APIキーは`Str::random(64)`で自動生成され、`user_api_keys`テーブルにSHA-256ハッシュと暗号化で保存される【High】

##### AC7: エラーハンドリング
- AC-A02-601: 拠点名が空の場合、バリデーションエラーが表示される【High】
- AC-A02-602: 管理者メールアドレスが重複している場合、バリデーションエラーが表示される【High】
- AC-A02-603: APIキーが未入力の場合、バリデーションエラーが表示される【High】

---

#### 4.3.3 A03: 拠点編集

**概要:**
拠点の詳細情報編集、所属ユーザー管理、APIキー管理、拠点削除を行う画面。URL: `/admin/teams/{id}`

**受入条件:**

##### AC1: 認証・認可
- AC-A03-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A03-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A03-003: 管理者ユーザー（is_admin=true）がアクセスした場合、拠点編集画面が表示される【High】

##### AC2: ページ表示
- AC-A03-101: パンくずナビゲーション「拠点管理 > {拠点名}」が表示される【Medium】
- AC-A03-102: 基本情報セクションに拠点名（チーム名）のみが表示される（プランはユーザー単位に移動したため削除）【High】
- AC-A03-103: 所属ユーザー管理セクションに全ユーザーが表示される（ユーザー名/メール、プラン名、登録日、操作）【High】
- AC-A03-104: 各ユーザー行にアバター、名前、メールアドレス（グレー表示）、プラン名、登録日が表示される【High】
- AC-A03-105: 各ユーザー行に編集ボタンと削除ボタンが表示される【High】
- AC-A03-106: Danger Zoneにチーム削除ボタンと説明が表示される【High】

##### AC3: データ操作（CRUD）
- AC-A03-201: 基本情報（チーム名のみ）を変更して保存ボタンをクリックした場合、Team情報が更新される【High】
- AC-A03-202: Team情報更新後、成功トースト「保存しました」が表示される【Medium】
- AC-A03-203: ユーザー追加ボタンをクリックした場合、新規ユーザー追加モーダルが表示される【High】
- AC-A03-204: 追加モーダルでお名前、メールアドレス、初期パスワード（8文字以上）、プラン（必須）を入力して送信した場合、新規ユーザーが作成され、UserApiKeyが自動生成されTeamに紐付けられる【High】
- AC-A03-205: ユーザー編集ボタンをクリックした場合、ユーザー編集モーダルが表示される（currentUserデータバインド、プランとAPIキー管理を含む）【High】
- AC-A03-206: 編集モーダルでお名前、メールアドレス、プランを変更して保存した場合、ユーザー情報が更新される【High】
- AC-A03-207: ユーザー削除ボタンをクリックした場合、削除確認モーダルが表示される【High】
- AC-A03-208: 削除確認モーダルで確認した場合、ユーザーとUserApiKeyが削除される【High】
- AC-A03-209: ユーザー編集モーダルのAPIキー表示ボタンをクリックした場合、マスクが解除され、平文APIキーが表示される【High】
- AC-A03-210: ユーザー編集モーダルのAPIキー再生成ボタンをクリックした場合、確認モーダルが表示される【High】
- AC-A03-211: APIキー再生成確認モーダルで再生成を実行した場合、ユーザーの新規APIキー（user_api_keys）が発行され、平文で表示される【High】
- AC-A03-212: チーム削除ボタンをクリックした場合、削除が実行される（確認モーダル必須）【High】

##### AC4: Livewireインタラクション
- AC-A03-401: APIキーコピーボタンをクリックした場合、APIキーがクリップボードにコピーされる【High】
- AC-A03-402: ユーザー編集ボタンをクリックした場合、currentUserオブジェクトにデータがバインドされ、モーダルに表示される【Medium】
- AC-A03-403: モーダルを開閉した場合、フォームがリセットされる【Medium】

##### AC5: ビジネスロジック
- AC-A03-501: ユーザーAPIキー（user_api_keys）再生成時、古いAPIキーは無効化（is_active=false）され、新しいキーが生成される【High】
- AC-A03-502: ユーザーAPIキーは`key_hash`（SHA-256）と`key_encrypted`（Laravel Encrypt）の両方で`user_api_keys`テーブルに保存される【High】
- AC-A03-503: 初期パスワードは8文字以上でなければならない【High】

##### AC6: エラーハンドリング
- AC-A03-601: チーム名が空の場合、バリデーションエラーが表示される【High】
- AC-A03-603: ユーザー追加時、お名前が空の場合、バリデーションエラーが表示される【High】
- AC-A03-604: ユーザー追加時、メールアドレスが空の場合、バリデーションエラーが表示される【High】
- AC-A03-605: ユーザー追加時、初期パスワードが10文字未満の場合、バリデーションエラーが表示される【High】
- AC-A03-609: ユーザー追加時、プランが未選択の場合、バリデーションエラーが表示される【High】
- AC-A03-606: ユーザー編集時、メールアドレスが重複している場合（自身を除外）、エラーメッセージが表示される【High】
- AC-A03-607: ユーザー追加時、パスワードに小文字・大文字・数字・記号のいずれかが不足している場合、バリデーションエラーが表示される【High】
- AC-A03-608: ユーザー追加時、よく使われるパスワード（password, admin, 12345678等）の場合、バリデーションエラーが表示される【High】

---

#### 4.3.4 A04: CSV一括登録

**概要:**
CSVファイルをアップロードして拠点を一括登録する画面。URL: `/admin/teams/import`

**受入条件:**

##### AC1: 認証・認可
- AC-A04-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A04-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A04-003: 管理者ユーザー（is_admin=true）がアクセスした場合、CSV一括登録画面が表示される【High】

##### AC2: ページ表示
- AC-A04-101: ドラッグ＆ドロップエリア（FileDropzone）が表示される【High】
- AC-A04-102: テンプレートCSVダウンロードリンクがヘッダー右側に表示される【Medium】
- AC-A04-103: ファイル選択後、ファイル選択エリアの下にアップロードファイル名とファイルサイズが表示される【High】
- AC-A04-104: ファイル選択後、プレビューテーブル（No, 拠点名, 契約プラン, 管理者名, 管理者Email）が表示される【High】
- AC-A04-105: プレビューテーブルに「※APIキーとユーザーパスワードは自動生成されます」の注記が表示される【Medium】
- AC-A04-106: インポート進行中、プログレスバーとログコンソールが表示される【High】

##### AC3: データ操作
- AC-A04-201: CSVファイル（name, plan, owner_name, email の4カラム）をアップロードした場合、プレビューが表示される【High】
- AC-A04-202: プレビューで先頭5件のデータが表示される【Medium】
- AC-A04-203: 「インポート開始」ボタンをクリックした場合、Team、User、TeamApiKey が一括作成される【High】
- AC-A04-204: インポート中、処理の流れがログコンソールに表示され、プログレスバーが更新される【Medium】
- AC-A04-205: インポート完了後、成功件数とエラー件数が表示される（例: 成功: 4, 失敗: 1）【High】
- AC-A04-206: インポート完了後、「一覧に戻る」ボタンと「続けてインポート」ボタンが表示される【High】
- AC-A04-207: 「続けてインポート」ボタンをクリックした場合、フォームがリセットされ、再度インポート可能になる【Medium】

##### AC4: バリデーション
- AC-A04-301: CSV形式（.csv）以外のファイルをアップロードした場合、エラーメッセージが表示される【High】
- AC-A04-302: 5MBを超えるファイルをアップロードした場合、エラーメッセージが表示される【High】
- AC-A04-303: CSVの列数が4列（name, plan, owner_name, email）でない場合、エラーメッセージが表示される【High】
- AC-A04-304: name（拠点名）が空の行がある場合、該当行のエラーがログに表示される【High】
- AC-A04-305: plan が plansテーブルに存在しない値の場合、該当行のエラーがログに表示される（planは任意項目）【High】
- AC-A04-306: owner_name（管理者名）が空の行がある場合、該当行のエラーがログに表示される【High】
- AC-A04-307: email が不正な形式の場合、該当行のエラーがログに表示される【High】

##### AC5: ビジネスロジック
- AC-A04-501: 重複するメールアドレス（email）の行はスキップされ、エラーログに記録される【High】
- AC-A04-502: 各行のインポート時、APIキーが自動生成される（`Str::random(64)`）【High】
- AC-A04-503: 各行のインポート時、ユーザーパスワードが自動生成される（10文字以上、小文字・大文字・数字・記号を全て含む）【High】
- AC-A04-504: インポート中にエラーが発生した場合、すべての変更がロールバックされる（DB::transaction使用）【High】
- AC-A04-505: インポート中、プログレスバーが`(処理済み行数 / 全行数) * 100`で進行状況を表示する【Medium】
- AC-A04-506: インポート中、ログコンソールにリアルタイムでログ（success/error）が表示される【Medium】
- AC-A04-507: 成功ログには「行X: {拠点名} - 登録成功 (ID: Team_X)」が表示される【Medium】
- AC-A04-508: エラーログには「行X: {拠点名} - {エラー内容}」が表示される【Medium】

---

#### 4.3.5 A05: Difyアプリ一覧

**概要:**
Difyアプリの一覧表示、検索、新規登録を行う画面。URL: `/admin/apps`

**受入条件:**

##### AC1: 認証・認可
- AC-A05-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A05-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A05-003: 管理者ユーザー（is_admin=true）がアクセスした場合、Difyアプリ一覧が表示される【High】

##### AC2: ページ表示
- AC-A05-101: Difyアプリ一覧テーブルに全アプリが表示される（ページネーション: 50件/ページ）【High】
- AC-A05-102: 各アプリに「アプリ名」「スラッグ」「接続設定」「ステータス」「最終更新」が表示される【High】
- AC-A05-103: アプリ名カラムにアイコンとアプリ名が表示される【Medium】
- AC-A05-104: スラッグカラムに`slug`がmonospace表示される【Medium】
- AC-A05-105: 接続設定カラムにAPIキー設定状態（緑チェックマーク）が表示される【Medium】
- AC-A05-106: ステータスカラムにToggleSwitch（Active/Inactive切替）が表示される【High】
- AC-A05-107: 最終更新カラムに相対時刻（例: 2時間前）が表示される【Medium】
- AC-A05-108: 検索バー（アプリ名、Slugで検索、debounce 300ms）が表示される【High】

##### AC3: データ操作（CRUD）
- AC-A05-201: 「新規登録」ボタンをクリックした場合、新規登録モーダルが表示される【High】
- AC-A05-202: 新規登録モーダルでアプリ名、Slug、Dify APIキー、DifyエンドポイントURLを入力して保存した場合、DifyAppが作成される（is_active=true）【High】
- AC-A05-203: アプリ作成時、Dify APIキーは暗号化（`encrypt()`）されて保存される【High】
- AC-A05-204: アプリ作成後、モーダルが閉じ、一覧が更新される【High】
- AC-A05-205: アプリ名（セル）をクリックした場合、A06（Difyアプリ編集画面）`/admin/apps/{id}` へ遷移する【High】

##### AC4: 検索・フィルタ
- AC-A05-301: 検索バーにアプリ名を入力した場合、部分一致でアプリが絞り込まれる（debounce 300ms、`wire:model.live.debounce.300ms`）【High】
- AC-A05-302: 検索バーにSlugを入力した場合、部分一致でアプリが絞り込まれる（debounce 300ms）【High】
- AC-A05-303: ページネーションをクリックした場合、次のページ（50件単位）が表示される【High】
- AC-A05-304: 検索実行時、ページネーションが1ページ目にリセットされる【High】

##### AC5: Livewireインタラクション
- AC-A05-401: ToggleSwitchをクリックした場合、アプリのステータス（`is_active`）が即座に変更される（確認なし）【High】
- AC-A05-402: ステータス変更時、成功トースト「アプリを有効化しました」または「アプリを無効化しました」が表示される【Medium】
- AC-A05-403: 検索入力中、debounce 300ms後にリアルタイムで一覧が更新される【High】

##### AC6: ビジネスロジック
- AC-A05-501: Dify APIキーは`api_key_encrypted`として暗号化（`encrypt()`）されて保存される【High】
- AC-A05-502: Slugは`dify_apps`テーブルで一意でなければならない【High】
- AC-A05-503: Slugは英数字とハイフンのみ許可される（regex: `/^[a-z0-9-]+$/`）【High】

##### AC7: エラーハンドリング
- AC-A05-601: アプリ名が空の場合、バリデーションエラーが表示される【High】
- AC-A05-602: Slugが空の場合、バリデーションエラーが表示される【High】
- AC-A05-603: Slugが重複している場合、バリデーションエラー「このSlugは既に使用されています」が表示される【High】
- AC-A05-604: Slugが英数字とハイフン以外の文字を含む場合、バリデーションエラーが表示される【High】
- AC-A05-605: Dify APIキーが空の場合、バリデーションエラーが表示される【High】
- AC-A05-606: エンドポイントURLが空の場合、バリデーションエラーが表示される【High】
- AC-A05-607: エンドポイントURLが不正なURL形式の場合、バリデーションエラーが表示される【High】

---

#### 4.3.6 A06: Difyアプリ編集

**概要:**
Difyアプリの詳細情報編集、削除を行う画面。URL: `/admin/apps/{id}`

**受入条件:**

##### AC1: 認証・認可
- AC-A06-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A06-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A06-003: 管理者ユーザー（is_admin=true）がアクセスした場合、アプリ編集画面が表示される【High】

##### AC2: ページ表示
- AC-A06-101: パンくずナビゲーション「Difyアプリ管理 > {アプリ名}」が表示される【Medium】
- AC-A06-102: 基本情報セクションにアプリ名、Slug、説明・メモ、ステータス（ToggleSwitch、緑: Active、グレー: Inactive）が表示される【High】
- AC-A06-103: Dify接続情報セクションにエンドポイントURL、Dify APIキー（マスク表示 + 表示/非表示切替）が表示される【High】
- AC-A06-104: Danger Zoneにアプリ削除ボタンと説明が表示される【High】

##### AC3: データ操作（CRUD）
- AC-A06-201: 基本情報（アプリ名、Slug、説明・メモ、エンドポイントURL、ステータス）を変更して保存ボタンをクリックした場合、DifyAppが更新される【High】
- AC-A06-202: アプリ情報更新後、成功トースト「保存しました」が表示される【Medium】
- AC-A06-203: 新しいAPIキー（Dify APIキー）を入力して更新ボタンをクリックした場合、`api_key_encrypted`が更新される【High】
- AC-A06-204: APIキー更新後、成功トースト「APIキーを更新しました」が表示される【Medium】
- AC-A06-205: アプリ削除ボタンをクリックした場合、削除確認モーダルが表示される【High】
- AC-A06-206: 削除確認モーダルで削除を実行した場合、DifyAppがソフトデリート（`deleted_at`に現在日時をセット）され、A05へリダイレクトされる【High】
- AC-A06-207: アプリ削除後も、関連する`monthly_api_usages`データは保持される（監査証跡・課金データとして利用）【High】

##### AC4: Livewireインタラクション
- AC-A06-401: Dify APIキー表示ボタンをクリックした場合、マスクが解除され、APIキー（復号化: `decrypt($app->api_key_encrypted)`）が表示される【High】
- AC-A06-402: ステータスToggleSwitch（Active/Inactive）を切り替えた場合、`is_active`が変更される【Medium】

##### AC5: ビジネスロジック
- AC-A06-501: Slugフィールドを変更した場合、警告メッセージ「Slugを変更すると既存の連携に影響があります」が表示される【High】
- AC-A06-502: Slugは自身を除いて一意でなければならない（`Rule::unique('dify_apps')->ignore($app->id)`）【High】
- AC-A06-503: 説明・メモは任意フィールドで、最大1000文字まで入力可能【Medium】
- AC-A06-504: DifyAppモデルは`SoftDeletes`トレイトを使用し、削除時は物理削除ではなく論理削除（`deleted_at`をセット）を行う【High】
- AC-A06-505: ソフトデリートされたアプリはデフォルトのクエリでは取得されない（A05一覧に表示されない）【High】

##### AC6: エラーハンドリング
- AC-A06-601: アプリ名が空の場合、バリデーションエラーが表示される【High】
- AC-A06-602: Slugが空の場合、バリデーションエラーが表示される【High】
- AC-A06-603: Slugが重複している場合（自身を除外）、バリデーションエラーが表示される【High】
- AC-A06-604: 説明・メモが1000文字を超える場合、バリデーションエラーが表示される【Medium】
- AC-A06-605: エンドポイントURLが空の場合、バリデーションエラーが表示される【High】
- AC-A06-606: 新APIキーが空の場合（更新時）、バリデーションエラーが表示される【High】

---

#### 4.3.7 A07: 利用状況一覧

**概要:**
月次利用実績の検索・一覧表示を行う画面。URL: `/admin/usages`

**受入条件:**

##### AC1: 認証・認可
- AC-A07-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A07-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A07-003: 管理者ユーザー（is_admin=true）がアクセスした場合、利用状況一覧が表示される【High】

##### AC2: ページ表示
- AC-A07-101: 利用状況一覧テーブルに全レコードが表示される（ページネーション: 50件/ページ）【High】
- AC-A07-102: 各レコードに「ユーザー名（拠点名をサブテキスト表示）」「プラン」「アプリ名」「対象月」「利用回数」「上限」「利用率」「操作」が表示される【High】
- AC-A07-103: 検索バー（ユーザー名・拠点名）、対象月フィルタ、Difyアプリフィルタが表示される【High】

##### AC3: データ操作
- AC-A07-201: 修正ボタンをクリックした場合、A08利用回数修正モーダルが表示される【High】
- AC-A07-202: CSV出力ボタンをクリックした場合、現在のフィルタ条件でCSVファイルがダウンロードされる【High】

##### AC4: 検索・フィルタ
- AC-A07-301: 検索バーにユーザー名または拠点名を入力した場合、部分一致でレコードが絞り込まれる（debounce 300ms、`monthly_api_usages.user_id` → `users.name` または `monthly_api_usages.team_id` → `teams.name` で検索）【High】
- AC-A07-302: 対象月フィルタを選択した場合、該当月のレコードのみ表示される【High】
- AC-A07-303: Difyアプリフィルタ（SelectInput）でアプリを選択した場合、該当アプリのレコードのみ表示される【High】
- AC-A07-304: 制限超過のみフィルタ（ToggleSwitch）をONにした場合、利用率100%超過のレコードのみ表示される【High】
- AC-A07-305: 複数のフィルタを組み合わせた場合、AND条件で絞り込まれる【Medium】
- AC-A07-306: ページネーションをクリックした場合、次のページ（50件単位）が表示される【High】
- AC-A07-307: 検索またはフィルタ実行時、ページネーションが1ページ目にリセットされる【High】

##### AC5: ビジネスロジック
- AC-A07-501: 利用率が90%以上のレコードの行が赤色で強調表示される【Medium】
- AC-A07-502: 利用率が100%を超えるレコードの利用回数が赤色で表示される【High】
- AC-A07-503: CSV出力時、現在のフィルタ条件（年月、拠点名、アプリ、制限超過のみ）がすべて適用される【High】
- AC-A07-504: CSV出力時、ファイル名は`usages_{YYYY-MM}.csv`形式で生成される【Medium】
- AC-A07-505: CSV出力時、UTF-8 BOM付きで出力される（Excel対応）【High】
- AC-A07-506: CSV出力時、ヘッダー行に「年月,ユーザー名,拠点名,プラン,アプリ名,利用回数,月間上限,利用率(%),最終更新」が含まれる【High】
- AC-A07-507: CSV出力時、削除されたアプリは「削除されたアプリ」と表示される【High】
- AC-A07-508: CSV出力時、利用率は小数点第1位まで表示される（例: 95.3）【Medium】
- AC-A07-509: CSV出力時、ページネーションは適用されず、全件が出力される【High】

---

#### 4.3.8 A08: 利用回数修正（モーダル）

**概要:**
利用回数の手動修正を行うモーダル。A07から呼び出される。

**受入条件:**

##### AC1: ページ表示
- AC-A08-101: モーダルに対象年月、契約プラン（ユーザーのプラン + 上限値）、ユーザー名（拠点名をサブテキスト）、アプリ名が表示される【High】
- AC-A08-102: 現在の利用回数と上限が表示される【High】
- AC-A08-103: 新しい利用回数入力フィールドが表示される【High】
- AC-A08-104: 修正理由のテキストエリアが表示される【High】

##### AC2: データ操作
- AC-A08-201: 新しい利用回数と修正理由を入力して保存ボタンをクリックした場合、`monthly_api_usages`のcountが更新される（対象レコードは`user_id`で特定）【High】
- AC-A08-202: 更新後、モーダルが閉じ、A07の一覧が更新される【High】

##### AC3: バリデーション
- AC-A08-301: 新しい利用回数が0未満の場合、バリデーションエラーが表示される【High】
- AC-A08-302: 修正理由が空の場合、バリデーションエラーが表示される【High】

##### AC4: ビジネスロジック
- AC-A08-401: 修正履歴が記録される（誰が、いつ、なぜ修正したか）【Medium】

---

#### 4.3.9 A09: 災害復旧エクスポート

**概要:**
災害復旧用のJSONデータをエクスポートする画面。URL: `/admin/dr/export`

**受入条件:**

##### AC1: 認証・認可
- AC-A09-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-A09-002: 一般ユーザー（is_admin=false）がアクセスした場合、403エラーが返される【High】
- AC-A09-003: 管理者ユーザー（is_admin=true）がアクセスした場合、エクスポート画面が表示される【High】

##### AC2: ページ表示
- AC-A09-101: 警告バナー（AlertBanner type="warning"）が表示される【High】
- AC-A09-102: 「バックアップデータを生成」ボタンが表示される【High】

##### AC3: データ操作
- AC-A09-201: 「バックアップデータを生成」ボタンをクリックした場合、プログレス表示後にJSONファイルが生成される【High】
- AC-A09-202: エクスポート完了後、JSONプレビューとダウンロードボタンが表示される【High】
- AC-A09-203: ダウンロードボタンをクリックした場合、`teams.json`ファイルがダウンロードされる【High】

##### AC4: ビジネスロジック
- AC-A09-401: エクスポートされるJSONには全拠点・全ユーザー・全APIキーが含まれる（選択不可、全件エクスポート）【High】
- AC-A09-402: APIキーは平文（復号化済み）の状態でエクスポートされる【High】

---

#### 4.3.10 U01: 拠点ダッシュボード（一般ユーザー）

**概要:**
一般ユーザーが自分の利用状況を確認する画面。URL: `/dashboard`

**受入条件:**

##### AC1: 認証・認可
- AC-U01-001: 未ログインユーザーがアクセスした場合、ログイン画面にリダイレクトされる【High】
- AC-U01-002: 一般ユーザーがアクセスした場合、自ユーザーのダッシュボードが表示される【High】
- AC-U01-003: 管理者ユーザーがアクセスした場合、A01へリダイレクトされる【Medium】

##### AC2: ページ表示
- AC-U01-101: ログインユーザーの今月の総利用回数、プラン月間上限、利用率（`monthly_api_usages WHERE user_id = auth()->id()`）が表示される【High】
- AC-U01-102: 利用率がプログレスバーで表示される（ユーザーのプランを参照: `user.plan.plan_limits`）【High】
- AC-U01-103: アプリ別利用状況テーブルが表示される【High】
- AC-U01-104: ユーザー情報サマリー（名前・拠点名・プラン・APIキー状態）が表示される【High】

##### AC3: アクセス制限
- AC-U01-301: 他ユーザーのデータは表示されない【High】
- AC-U01-302: データの編集・削除ボタンは表示されない（閲覧のみ）【High】

##### AC4: セキュリティ
- AC-U01-401: URLにパラメータが含まれていても無視され、必ず`auth()->id()`のデータのみ表示される【High】
- AC-U01-402: 常にログインユーザーの`user_id`で`monthly_api_usages`が取得される（`user_id`直接参照）【High】
- AC-U01-403: リクエストパラメータからIDを受け取るコードは実装されていない【High】

---

#### 4.3.11 G01: ログイン

**概要:**
全ユーザー（管理者・一般ユーザー共通）のログイン画面。Laravel Fortifyを使用してメールアドレスとパスワードで認証を行う。管理者の場合は二段階認証（G02）へ、一般ユーザーの場合は直接ダッシュボード（U01）へリダイレクトされる。URL: `/login`

**受入条件:**

##### AC1: 基本表示
- AC-G01-101: ページにロゴ、「Dify Gateway」タイトル、メールアドレス入力欄、パスワード入力欄、ログインボタンが表示される【High】

##### AC2: 認証フロー
- AC-G01-201: 正しいメールアドレスとパスワードを入力してログインした場合、Fortify認証が成功する【High】
- AC-G01-202: 管理者ユーザー（is_admin=true）がログインした場合、以下の処理が実行される【High】
  - OTPコード（6桁）が生成される
  - ユーザーID=1の管理者のメールアドレスにOTPコードが送信される
  - セッションに`two_factor_pending`と`two_factor_user_id`が保存される
  - 一旦ログアウト処理が実行される
  - G02（二段階認証画面）へリダイレクトされる
- AC-G01-203: 一般ユーザー（is_admin=false）がログインした場合、U01（拠点ダッシュボード）へリダイレクトされる【High】
- AC-G01-204: メールアドレスまたはパスワードが間違っている場合、エラーメッセージ「メールアドレスまたはパスワードが正しくありません。」が表示される【High】

##### AC3: バリデーション
- AC-G01-301: メールアドレスが空の場合、バリデーションエラー「メールアドレスを入力してください」が表示される【High】
- AC-G01-302: メールアドレス形式が不正な場合、バリデーションエラー「正しいメールアドレスを入力してください」が表示される【High】
- AC-G01-303: パスワードが空の場合、バリデーションエラー「パスワードを入力してください」が表示される【High】

##### AC4: インタラクション
- AC-G01-401: Enterキー押下時、ログインボタンクリックと同じ動作が実行される【Medium】
- AC-G01-402: ログイン処理中、ログインボタンが無効化され「認証中...」と表示される【Medium】

##### AC5: エラーハンドリング
- AC-G01-501: 管理者ログイン時、ユーザーID=1の管理者が存在しない場合、エラーメッセージ「システムエラーが発生しました。管理者にお問い合わせください。」が表示される【High】

---

#### 4.3.12 G02: 二段階認証コード入力

**概要:**
管理者ログイン時の二段階認証画面。ユーザーID=1の管理者のメールアドレスに送信されたOTPコードを入力。URL: `/two-factor-challenge`

**受入条件:**

##### AC1: ページ表示
- AC-G02-001: セッションに「二段階認証待ち」フラグがない場合、G01へリダイレクトされる【High】
- AC-G02-002: ページに「ユーザーID=1の管理者のメールアドレスに6桁の認証コードを送信しました」と表示される【High】
- AC-G02-003: 6桁の認証コード入力フィールドが表示される【High】
- AC-G02-004: 「認証する」「コードを再送信」「ログアウト」ボタンが表示される【High】

##### AC2: OTPコード送信
- AC-G02-101: 管理者ログイン成功時、ユーザーID=1の管理者のメールアドレスにのみOTPコードが送信される【High】
- AC-G02-102: OTPコードは6桁の数字で生成される【High】
- AC-G02-103: OTPコードの有効期限は10分である【High】
- AC-G02-104: メールにログイン試行者の情報（ID、名前、メールアドレス）が含まれる【High】

##### AC3: OTPコード検証
- AC-G02-201: 正しいOTPコードを入力して「認証する」ボタンをクリックした場合、A01へリダイレクトされる【High】
- AC-G02-202: 間違ったOTPコードを入力した場合、エラーメッセージが表示され、試行回数がカウントされる【High】
- AC-G02-203: 5回連続で間違ったOTPコードを入力した場合、トークンが無効化され、G01へリダイレクトされる【High】
- AC-G02-204: 有効期限切れのOTPコードを入力した場合、エラーメッセージが表示され、G01へリダイレクトされる【High】

##### AC4: アクション
- AC-G02-301: 「コードを再送信」ボタンをクリックした場合、新しいOTPコードがユーザーID=1の管理者に送信される【High】
- AC-G02-302: 「ログアウト」ボタンをクリックした場合、セッションがクリアされ、G01へリダイレクトされる【High】

##### AC5: バリデーション
- AC-G02-401: 認証コードが空の場合、バリデーションエラーが表示される【High】
- AC-G02-402: 認証コードが6桁でない場合、バリデーションエラーが表示される【High】

---

## 5. テストケース一覧

### 5.1 テストケース表フォーマット

各テストケースは以下の形式で記載します：

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A01-001 | ... | - | ... | ... | High | pending | AC-A01-001 |

---

### 5.2 画面別テストケース

---

#### 5.2.1 A01: 管理者ダッシュボード

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A01-001 | 未ログインでのアクセス | 未ログイン | `/admin` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A01-001 |
| TC-A01-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin` へGETリクエスト | 403エラー | High | pending | AC-A01-002 |
| TC-A01-003 | 管理者でのアクセス | 管理者でログイン | `/admin` へGETリクエスト | 200ステータス、ダッシュボード表示 | High | pending | AC-A01-003 |
| TC-A01-004 | KPIカード表示 | 管理者でログイン、テストデータあり | ダッシュボードを表示 | 契約拠点数、総リクエスト、稼働アプリが表示される | High | pending | AC-A01-101 |
| TC-A01-005 | 契約拠点数の表示 | 管理者でログイン、5拠点存在 | ダッシュボードを表示 | 契約拠点数に「5」が表示される | High | pending | AC-A01-102 |
| TC-A01-006 | 今月の総リクエスト表示 | 管理者でログイン、今月の利用実績あり | ダッシュボードを表示 | 今月の総リクエスト数が表示される | High | pending | AC-A01-103 |
| TC-A01-007 | 稼働Difyアプリ表示 | 管理者でログイン、アクティブアプリ3件 | ダッシュボードを表示 | 稼働Difyアプリに「3」が表示される | High | pending | AC-A01-104 |
| TC-A01-008 | 利用率上位5件表示 | 管理者でログイン、10拠点存在 | ダッシュボードを表示 | 利用率の高い上位5拠点のみ表示される | High | pending | AC-A01-105 |
| TC-A01-009 | 利用率プログレスバー表示 | 管理者でログイン、利用率75%の拠点あり | ダッシュボードを表示 | プログレスバーが75%で表示される | Medium | pending | AC-A01-106 |
| TC-A01-010 | 編集ボタンクリック | 管理者でログイン | 拠点の編集ボタンをクリック | `/admin/teams/{id}` へ遷移 | High | pending | AC-A01-201 |
| TC-A01-011 | すべて見るリンククリック | 管理者でログイン | 「すべて見る」リンクをクリック | `/admin/teams` へ遷移 | Medium | pending | AC-A01-202 |
| TC-A01-012 | 利用率90%以上の表示 | 管理者でログイン、利用率95%の拠点あり | ダッシュボードを表示 | プログレスバーが赤色で表示される | Medium | pending | AC-A01-502 |

---

#### 5.2.2 A02: 拠点一覧

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A02-001 | 未ログインでのアクセス | 未ログイン | `/admin/teams` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A02-001 |
| TC-A02-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin/teams` へGETリクエスト | 403エラー | High | pending | AC-A02-002 |
| TC-A02-003 | 管理者でのアクセス | 管理者でログイン | `/admin/teams` へGETリクエスト | 200ステータス、拠点一覧表示 | High | pending | AC-A02-003 |
| TC-A02-004 | 拠点一覧表示（50件/ページ） | 管理者でログイン、60拠点存在 | 拠点一覧を表示 | 最初の50件が表示される | High | pending | AC-A02-101 |
| TC-A02-005 | 拠点詳細情報表示 | 管理者でログイン、拠点あり | 拠点一覧を表示 | 拠点名、プラン/利用率、管理者、最終アクセスが表示される | High | pending | AC-A02-102 |
| TC-A02-006 | 新規作成ボタンクリック | 管理者でログイン | 「新規作成」ボタンをクリック | 新規作成モーダルが表示され、APIキーが自動生成される | High | pending | AC-A02-201, AC-A02-202 |
| TC-A02-007 | APIキー再生成 | モーダル表示中 | APIキー再生成ボタンをクリック | 新しい64文字のAPIキーが生成される | Medium | pending | AC-A02-203 |
| TC-A02-008 | 拠点新規作成 | モーダル表示中 | 拠点名、プラン、APIキー（自動生成済み）を確認して保存 | TeamとTeamApiKeyが作成され、一覧が更新される | High | pending | AC-A02-204 |
| TC-A02-009 | バリデーションエラー（拠点名） | モーダル表示中 | 拠点名を空で保存 | バリデーションエラーが表示される | High | pending | AC-A02-601 |
| TC-A02-010 | バリデーションエラー（契約プラン） | モーダル表示中 | 契約プランを未選択で保存 | バリデーションエラーが表示される | High | pending | AC-A02-602 |
| TC-A02-011 | バリデーションエラー（APIキー） | モーダル表示中 | APIキーを削除して保存 | バリデーションエラーが表示される | High | pending | AC-A02-603 |
| TC-A02-012 | 検索機能（拠点名） | 管理者でログイン、10拠点存在 | 検索バーに「東京」と入力（debounce 300ms） | 「東京」を含む拠点のみ表示される | High | pending | AC-A02-301 |
| TC-A02-013 | 検索機能（担当者名） | 管理者でログイン、複数拠点存在 | 検索バーにオーナー名を入力（debounce 300ms） | 該当オーナーの拠点のみ表示される | High | pending | AC-A02-302 |
| TC-A02-014 | 制限超過フィルタ | 管理者でログイン、制限超過拠点あり | 制限超過フィルタ（ToggleSwitch）をON | 利用率100%超過の拠点のみ表示される | High | pending | AC-A02-303 |
| TC-A02-015 | プランフィルタ | 管理者でログイン、複数プランの拠点あり | プランフィルタで「Standard」を選択 | Standardプランの拠点のみ表示される | High | pending | AC-A02-304 |
| TC-A02-016 | ページネーション（50件単位） | 管理者でログイン、60拠点存在 | ページ2をクリック | 51-60件目が表示される | High | pending | AC-A02-306 |
| TC-A02-017 | 拠点名クリックで遷移 | 管理者でログイン、拠点あり | 拠点名セルをクリック | `/admin/teams/{id}` へ遷移 | High | pending | AC-A02-207 |
| TC-A02-018 | 検索実行時のページリセット | 管理者でログイン、60拠点存在、ページ2を表示中 | 検索バーに「東京」と入力 | 検索結果が表示され、ページネーションが1ページ目にリセットされる | High | pending | AC-A02-307 |

---

#### 5.2.3 A03: 拠点編集

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A03-001 | 未ログインでのアクセス | 未ログイン | `/admin/teams/1` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A03-001 |
| TC-A03-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin/teams/1` へGETリクエスト | 403エラー | High | pending | AC-A03-002 |
| TC-A03-003 | 管理者でのアクセス | 管理者でログイン、拠点ID=1 | `/admin/teams/1` へGETリクエスト | 200ステータス、拠点編集画面表示 | High | pending | AC-A03-003 |
| TC-A03-004 | 基本情報表示 | 管理者でログイン、拠点あり | 拠点編集画面を表示 | チーム名、プラン（月間リクエスト制限表示付き）が表示される | High | pending | AC-A03-102 |
| TC-A03-005 | 所属ユーザー一覧表示 | 管理者でログイン、拠点に複数ユーザー所属 | 拠点編集画面を表示 | 所属する全ユーザー（アバター、名前、メール、登録日、編集/削除ボタン）が表示される | High | pending | AC-A03-103, AC-A03-104 |
| TC-A03-006 | APIキー管理セクション表示 | 管理者でログイン、拠点あり | 拠点編集画面を表示 | APIキー（マスク表示）、最終利用日時が表示される | High | pending | AC-A03-106, AC-A03-107 |
| TC-A03-007 | 基本情報更新 | 管理者でログイン、拠点あり | チーム名を変更して保存 | Team情報が更新され、成功トースト「保存しました」表示 | High | pending | AC-A03-201, AC-A03-202 |
| TC-A03-008 | ユーザー追加 | 管理者でログイン、拠点あり | ユーザー追加ボタンクリック、名前/メール/パスワード（8文字以上）入力 | 新規ユーザーが作成され、Teamに紐付けられる | High | pending | AC-A03-204 |
| TC-A03-009 | ユーザー編集 | 管理者でログイン、拠点あり | ユーザー編集ボタンクリック、名前/メール変更 | ユーザー情報が更新される | High | pending | AC-A03-206 |
| TC-A03-010 | ユーザー削除確認モーダル表示 | 管理者でログイン、拠点に一般ユーザーあり | ユーザー削除ボタンクリック | 削除確認モーダルが表示される | High | pending | AC-A03-207 |
| TC-A03-011 | ユーザー削除実行 | 削除確認モーダル表示中 | 確認ボタンをクリック | ユーザーが削除される | High | pending | AC-A03-208 |
| TC-A03-012 | APIキー表示 | 管理者でログイン、拠点あり | APIキー表示ボタンをクリック | マスクが解除され平文表示される | High | pending | AC-A03-209 |
| TC-A03-013 | APIキーコピー | 管理者でログイン、拠点あり | APIキーコピーボタンをクリック | APIキーがクリップボードにコピーされる | High | pending | AC-A03-401 |
| TC-A03-014 | APIキー再生成 | 管理者でログイン、拠点あり | APIキー再生成ボタンクリック、確認 | 新規APIキーが発行され、平文で表示される | High | pending | AC-A03-211 |
| TC-A03-015 | チーム削除 | 管理者でログイン、拠点あり | チーム削除ボタンクリック | 削除が実行される | High | pending | AC-A03-212 |
| TC-A03-016 | パスワード10文字未満エラー | ユーザー追加モーダル表示中 | 初期パスワードに「Pass123!」（8文字）を入力 | バリデーションエラー「10文字以上で入力してください」が表示される | High | pending | AC-A03-605 |
| TC-A03-017 | メールアドレス空白エラー | ユーザー追加モーダル表示中 | メールアドレスを空で保存 | バリデーションエラーが表示される | High | pending | AC-A03-604 |
| TC-A03-018 | ユーザー名空白エラー | ユーザー追加モーダル表示中 | お名前を空で保存 | バリデーションエラーが表示される | High | pending | AC-A03-603 |
| TC-A03-019 | パスワード文字種不足エラー | ユーザー追加モーダル表示中 | 初期パスワードに「password123」（記号なし）を入力 | バリデーションエラー「小文字・大文字・数字・記号を全て含めてください」が表示される | High | pending | AC-A03-607 |
| TC-A03-020 | よく使われるパスワードエラー | ユーザー追加モーダル表示中 | 初期パスワードに「Password123!」（ブラックリスト該当）を入力 | バリデーションエラー「このパスワードはよく使われるため使用できません」が表示される | High | pending | AC-A03-608 |

---

#### 5.2.4 A04: CSV一括登録

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A04-001 | 未ログインでのアクセス | 未ログイン | `/admin/teams/import` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A04-001 |
| TC-A04-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin/teams/import` へGETリクエスト | 403エラー | High | pending | AC-A04-002 |
| TC-A04-003 | 管理者でのアクセス | 管理者でログイン | `/admin/teams/import` へGETリクエスト | 200ステータス、CSV一括登録画面表示 | High | pending | AC-A04-003 |
| TC-A04-004 | ファイル名とサイズ表示 | 管理者でログイン | CSVファイルをアップロード | ファイル選択エリアの下にファイル名とサイズ（KB）が表示される | High | pending | AC-A04-103 |
| TC-A04-005 | CSVアップロード（name,plan,owner_name,email） | 管理者でログイン | 4カラムのCSVをアップロード | プレビューテーブル（No,拠点名,契約プラン,管理者名,管理者Email）が表示される | High | pending | AC-A04-201, AC-A04-104 |
| TC-A04-006 | プレビュー先頭5件表示 | CSVアップロード済み（10件） | - | 先頭5件のデータが表示される | Medium | pending | AC-A04-202 |
| TC-A04-007 | インポート実行 | CSVアップロード済み | 「インポート開始」ボタンをクリック | Team、User（パスワード10文字以上・全文字種含む自動生成）、TeamApiKey（自動生成）が一括作成される | High | pending | AC-A04-203, AC-A04-502, AC-A04-503 |
| TC-A04-008 | インポート進行状況表示 | インポート実行中 | - | ログコンソールに処理フローが表示され、プログレスバーが更新される | Medium | pending | AC-A04-204 |
| TC-A04-009 | インポート完了表示 | インポート完了 | - | 成功件数とエラー件数が表示される（例: 成功: 4, 失敗: 1） | High | pending | AC-A04-205 |
| TC-A04-010 | 続けてインポートボタン | インポート完了 | 「続けてインポート」ボタンをクリック | フォームがリセットされ、再度インポート可能になる | High | pending | AC-A04-207 |
| TC-A04-011 | CSV形式エラー | 管理者でログイン | TXTファイルをアップロード | エラーメッセージが表示される | High | pending | AC-A04-301 |
| TC-A04-012 | ファイルサイズエラー | 管理者でログイン | 5MB超過のCSVをアップロード | エラーメッセージが表示される | High | pending | AC-A04-302 |
| TC-A04-013 | CSV列数エラー | 管理者でログイン | 4列でないCSVをアップロード | エラーメッセージが表示される | High | pending | AC-A04-303 |
| TC-A04-014 | 拠点名空エラー | 管理者でログイン | 拠点名（name）が空の行があるCSVをアップロード | 該当行のエラーがログに表示される | High | pending | AC-A04-304 |
| TC-A04-015 | プラン存在チェック | 管理者でログイン | planに存在しないプラン名を含むCSVをアップロード | 該当行のエラーがログに表示される | High | pending | AC-A04-305 |
| TC-A04-016 | 管理者名空エラー | 管理者でログイン | owner_nameが空の行があるCSVをアップロード | 該当行のエラーがログに表示される | High | pending | AC-A04-306 |
| TC-A04-017 | メール形式エラー | 管理者でログイン | emailが不正な形式の行があるCSVをアップロード | 該当行のエラーがログに表示される | High | pending | AC-A04-307 |
| TC-A04-018 | メール重複処理 | 管理者でログイン | 既存メールアドレスを含むCSVをアップロード | 重複行がスキップされ、エラーログに記録される | High | pending | AC-A04-501 |
| TC-A04-019 | エラー時のロールバック | 管理者でログイン、一部データ不正のCSV | 「インポート開始」ボタンをクリック | エラー発生時、すべての変更がロールバックされる | High | pending | AC-A04-504 |

---

#### 5.2.5 A05: Difyアプリ一覧

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A05-001 | 未ログインでのアクセス | 未ログイン | `/admin/apps` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A05-001 |
| TC-A05-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin/apps` へGETリクエスト | 403エラー | High | pending | AC-A05-002 |
| TC-A05-003 | 管理者でのアクセス | 管理者でログイン | `/admin/apps` へGETリクエスト | 200ステータス、Difyアプリ一覧表示 | High | pending | AC-A05-003 |
| TC-A05-004 | アプリ一覧表示（50件単位） | 管理者でログイン、60アプリ存在 | アプリ一覧を表示 | 最初の50件（アプリ名, スラッグ, 接続設定, ステータス, 最終更新）が表示される | High | pending | AC-A05-101, AC-A05-306 |
| TC-A05-005 | 新規登録ボタンクリック | 管理者でログイン | 「新規登録」ボタンをクリック | 新規登録モーダル（アプリ名、Slug、Dify APIキー、Difyエンドポイント）が表示される | High | pending | AC-A05-201 |
| TC-A05-006 | アプリ新規作成 | モーダル表示中 | アプリ名、Slug、Dify APIキー、エンドポイントURLを入力して保存 | アプリが作成され（is_active=true）、一覧が更新される | High | pending | AC-A05-202 |
| TC-A05-007 | 検索機能（debounce 300ms） | 管理者でログイン、10アプリ存在 | 検索バーに「Chat」と入力 | 300ms後に「Chat」を含むアプリ（name/slugで部分一致）のみ表示される | High | pending | AC-A05-301 |
| TC-A05-008 | ステータス切替 | 管理者でログイン、アプリあり | ToggleSwitchをクリック | アプリのis_activeが即座にトグルされ、トースト表示される | High | pending | AC-A05-401 |
| TC-A05-009 | アプリ名クリックで遷移 | 管理者でログイン、アプリあり | アプリ名セルをクリック | `/admin/apps/{id}` （A06）へ遷移 | High | pending | AC-A05-205 |
| TC-A05-010 | 接続設定状態表示 | 管理者でログイン、api_key_encrypted設定済みアプリあり | アプリ一覧を表示 | 接続設定列に緑チェックマークが表示される | High | pending | AC-A05-104 |
| TC-A05-011 | Slug重複エラー | 新規登録モーダル表示中 | 既存のSlugでアプリ作成 | バリデーションエラー「このslugは既に使用されています」が表示される | High | pending | AC-A05-603 |
| TC-A05-012 | ページネーション（50件単位） | 管理者でログイン、60アプリ存在 | ページ2をクリック | 51-60件目が表示される | High | pending | AC-A05-303 |
| TC-A05-013 | 検索実行時のページリセット | 管理者でログイン、60アプリ存在、ページ2を表示中 | 検索バーに「Chat」と入力 | 検索結果が表示され、ページネーションが1ページ目にリセットされる | High | pending | AC-A05-304 |

---

#### 5.2.6 A06: Difyアプリ編集

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A06-001 | 未ログインでのアクセス | 未ログイン | `/admin/apps/1` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A06-001 |
| TC-A06-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin/apps/1` へGETリクエスト | 403エラー | High | pending | AC-A06-002 |
| TC-A06-003 | 管理者でのアクセス | 管理者でログイン、アプリID=1 | `/admin/apps/1` へGETリクエスト | 200ステータス、アプリ編集画面表示 | High | pending | AC-A06-003 |
| TC-A06-004 | 基本情報セクション表示 | 管理者でログイン、アプリあり | アプリ編集画面を表示 | アプリ名、Slug（readonly）、説明・メモ、ステータス（ToggleSwitch）が表示される | High | pending | AC-A06-102, AC-A06-103 |
| TC-A06-005 | Dify接続情報セクション表示 | 管理者でログイン、アプリあり | アプリ編集画面を表示 | エンドポイントURL、Dify APIキー（マスク表示）、更新ボタンが表示される | High | pending | AC-A06-104 |
| TC-A06-006 | 基本情報更新 | 管理者でログイン、アプリあり | アプリ名、説明を変更して保存 | DifyApp更新、トースト「保存しました」表示 | High | pending | AC-A06-201 |
| TC-A06-007 | Slug変更時警告 | 管理者でログイン、アプリあり | Slugフィールドを変更 | 警告メッセージが表示される（既存連携への影響） | High | pending | AC-A06-501 |
| TC-A06-008 | APIキー表示 | 管理者でログイン、アプリあり | APIキー表示ボタンをクリック | マスクが解除され、復号されたAPIキーが表示される | High | pending | AC-A06-401 |
| TC-A06-009 | APIキー更新 | 管理者でログイン、アプリあり | 新しいAPIキーを入力して更新ボタンクリック | api_key_encrypted が暗号化保存され、トースト「APIキーを更新しました」表示 | High | pending | AC-A06-204 |
| TC-A06-010 | アプリ削除（ソフトデリート） | 管理者でログイン、アプリあり | アプリ削除ボタンクリック、確認モーダルで確認 | deleted_atがセットされ（ソフトデリート）、A05へリダイレクト | High | pending | AC-A06-206 |
| TC-A06-011 | 削除後のデータ保持確認 | TC-A06-010実行後 | monthly_api_usagesテーブルを確認 | 削除されたアプリのmonthly_api_usagesデータが保持されている | High | pending | AC-A06-207 |
| TC-A06-012 | 削除後の一覧非表示確認 | TC-A06-010実行後 | A05アプリ一覧を表示 | 削除されたアプリが一覧に表示されない | High | pending | AC-A06-505 |
| TC-A06-013 | 説明・メモ最大長超過エラー | 管理者でログイン | 説明・メモに1001文字入力 | バリデーションエラー「1000文字以内で入力してください」表示 | High | pending | AC-A06-604 |

---

#### 5.2.7 A07: 利用状況一覧

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A07-001 | 未ログインでのアクセス | 未ログイン | `/admin/usages` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A07-001 |
| TC-A07-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin/usages` へGETリクエスト | 403エラー | High | pending | AC-A07-002 |
| TC-A07-003 | 管理者でのアクセス | 管理者でログイン | `/admin/usages` へGETリクエスト | 200ステータス、利用状況一覧表示 | High | pending | AC-A07-003 |
| TC-A07-004 | 利用状況一覧表示（50件単位） | 管理者でログイン、60レコード存在 | 利用状況一覧を表示 | 最初の50件が表示される | High | pending | AC-A07-101, AC-A07-306 |
| TC-A07-005 | ページヘッダー表示 | 管理者でログイン | 利用状況一覧を表示 | タイトル「利用状況・実績管理」、説明文、再読込ボタン、CSV出力ボタンが表示される | High | pending | AC-A07-103 |
| TC-A07-006 | フィルタバー表示 | 管理者でログイン | 利用状況一覧を表示 | 対象年月、拠点名検索、Difyアプリフィルタ、制限超過のみトグルが表示される | High | pending | AC-A07-103 |
| TC-A07-007 | テーブルカラムヘッダー表示 | 管理者でログイン | 利用状況一覧を表示 | 「年月」「拠点名/プラン」「利用アプリ」「利用状況」「最終更新」「操作」のカラムヘッダーが表示される | High | pending | AC-A07-102 |
| TC-A07-008 | 対象年月の初期値 | 管理者でログイン | 利用状況一覧を表示 | 対象年月フィルタに今月（now()->format('Y-m')）が初期表示される | High | pending | AC-A07-103 |
| TC-A07-009 | 検索機能（debounce 300ms） | 管理者でログイン、複数拠点の利用実績あり | 検索バーに拠点名を入力 | 300ms後に該当拠点のレコード（Team.nameで部分一致）のみ表示される | High | pending | AC-A07-301 |
| TC-A07-010 | 対象月フィルタ | 管理者でログイン、複数月の利用実績あり | 対象月フィルタで「2024-01」を選択 | 2024年1月のレコードのみ表示される | High | pending | AC-A07-302 |
| TC-A07-011 | 利用率90%以上の強調表示 | 管理者でログイン、利用率95%のレコードあり | 利用状況一覧を表示 | 該当行が赤色（text-red-600等）で強調表示される | Medium | pending | AC-A07-501 |
| TC-A07-012 | 利用率100%超過の表示 | 管理者でログイン、利用率105%のレコードあり | 利用状況一覧を表示 | 利用回数が赤色（text-red-600 font-bold）で表示される | High | pending | AC-A07-502 |
| TC-A07-013 | Difyアプリフィルタ | 管理者でログイン、複数アプリの利用実績あり | Difyアプリフィルタで特定アプリを選択 | 該当アプリのレコードのみ表示される | High | pending | AC-A07-303 |
| TC-A07-014 | 制限超過のみフィルタ | 管理者でログイン、超過/未超過レコードあり | 制限超過のみトグルをON | 利用率100%超過のレコードのみ表示される | High | pending | AC-A07-304 |
| TC-A07-015 | 複数フィルタの組み合わせ | 管理者でログイン、複数レコードあり | 対象月、拠点名、アプリ、制限超過フィルタを組み合わせ | AND条件で絞り込まれる | Medium | pending | AC-A07-305 |
| TC-A07-016 | CSV出力ボタンクリック | 管理者でログイン、レコードあり | CSV出力ボタンをクリック | `usages_{YYYY-MM}.csv`ファイルがダウンロードされる | High | pending | AC-A07-202, AC-A07-504 |
| TC-A07-017 | CSV出力（フィルタ適用） | 対象月「2024-01」でフィルタ中 | CSV出力ボタンをクリック | フィルタ条件が適用されたデータのみCSV出力される | High | pending | AC-A07-503 |
| TC-A07-018 | CSV出力（ヘッダー確認） | 管理者でログイン | CSV出力を実行 | ヘッダー行に「年月,拠点名,プラン,アプリ名,利用回数,月間上限,利用率(%),最終更新」が含まれる | High | pending | AC-A07-506 |
| TC-A07-019 | CSV出力（削除されたアプリ） | 削除されたアプリの利用実績あり | CSV出力を実行 | アプリ名列に「削除されたアプリ」と表示される | High | pending | AC-A07-507 |
| TC-A07-020 | CSV出力（全件出力） | 管理者でログイン、60レコード存在 | CSV出力を実行 | ページネーションなしで全60件が出力される | High | pending | AC-A07-509 |
| TC-A07-021 | CSV出力（UTF-8 BOM） | 管理者でログイン | CSV出力を実行してExcelで開く | 日本語が正しく表示される（UTF-8 BOM付き） | High | pending | AC-A07-505 |
| TC-A07-022 | 修正ボタンクリック | 管理者でログイン | 修正ボタンをクリック | A08利用回数修正モーダルが表示される | High | pending | AC-A07-201 |
| TC-A07-023 | ページネーション（50件単位） | 管理者でログイン、60レコード存在 | ページ2をクリック | 51-60件目が表示される | High | pending | AC-A07-306 |
| TC-A07-024 | フィルタ実行時のページリセット | 管理者でログイン、60レコード存在、ページ2を表示中 | 対象月フィルタを変更 | フィルタ結果が表示され、ページネーションが1ページ目にリセットされる | High | pending | AC-A07-307 |

---

#### 5.2.8 A08: 利用回数修正（モーダル）

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A08-001 | モーダル表示 | A07から修正ボタンクリック | - | 対象年月、契約プラン（プラン名+上限値）、拠点名、アプリ名、現在の利用回数が表示される | High | pending | AC-A08-101, AC-A08-102 |
| TC-A08-002 | 利用回数更新 | モーダル表示中 | 新しい利用回数と修正理由を入力して保存 | 利用回数が更新され、モーダルが閉じる | High | pending | AC-A08-201 |
| TC-A08-003 | 負の値エラー | モーダル表示中 | 新しい利用回数に「-10」を入力 | バリデーションエラーが表示される | High | pending | AC-A08-301 |
| TC-A08-004 | 修正理由必須エラー | モーダル表示中 | 修正理由を空で保存 | バリデーションエラーが表示される | High | pending | AC-A08-302 |

---

#### 5.2.9 A09: 災害復旧エクスポート

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-A09-001 | 未ログインでのアクセス | 未ログイン | `/admin/dr/export` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-A09-001 |
| TC-A09-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/admin/dr/export` へGETリクエスト | 403エラー | High | pending | AC-A09-002 |
| TC-A09-003 | 管理者でのアクセス | 管理者でログイン | `/admin/dr/export` へGETリクエスト | 200ステータス、エクスポート画面表示 | High | pending | AC-A09-003 |
| TC-A09-004 | 警告バナー表示 | 管理者でログイン | エクスポート画面を表示 | 警告バナー（APIキーが含まれることの注意喚起）が表示される | High | pending | AC-A09-101 |
| TC-A09-005 | 生成ボタン表示 | 管理者でログイン | エクスポート画面を表示 | 「バックアップデータを生成」ボタンが表示される | High | pending | AC-A09-102 |
| TC-A09-006 | エクスポート実行 | 管理者でログイン | 「バックアップデータを生成」ボタンをクリック | プログレス表示後、JSONプレビューとダウンロードボタンが表示される | High | pending | AC-A09-201, AC-A09-202 |
| TC-A09-007 | JSONダウンロード | エクスポート完了 | ダウンロードボタンをクリック | `teams.json`ファイルがダウンロードされる | High | pending | AC-A09-203 |
| TC-A09-008 | 全データエクスポート | 管理者でログイン、5拠点存在 | エクスポートを実行 | JSONに全5拠点とその全ユーザー、全APIキーが含まれる | High | pending | AC-A09-401 |
| TC-A09-009 | APIキー平文エクスポート | 管理者でログイン | エクスポートを実行 | JSON内のAPIキーが平文（復号化済み）で含まれる | High | pending | AC-A09-402 |

---

#### 5.2.10 U01: 拠点ダッシュボード（一般ユーザー）

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-U01-001 | 未ログインでのアクセス | 未ログイン | `/dashboard` へGETリクエスト | `/login` へリダイレクト | High | pending | AC-U01-001 |
| TC-U01-002 | 一般ユーザーでのアクセス | 一般ユーザーでログイン | `/dashboard` へGETリクエスト | 200ステータス、拠点ダッシュボード表示 | High | pending | AC-U01-002 |
| TC-U01-003 | 利用状況表示 | 一般ユーザーでログイン | ダッシュボードを表示 | 自チームの今月の利用状況が表示される | High | pending | AC-U01-101 |
| TC-U01-004 | 他チームデータ非表示 | 一般ユーザーでログイン | ダッシュボードを表示 | 自チームのデータのみ表示される | High | pending | AC-U01-301 |
| TC-U01-005 | 編集ボタン非表示 | 一般ユーザーでログイン | ダッシュボードを表示 | 編集・削除ボタンが表示されない | High | pending | AC-U01-302 |
| TC-U01-006 | team_idパラメータ無視 | 一般ユーザー（Team A所属）でログイン | `/dashboard?team_id=999` へアクセス | Team Aのデータのみ表示され、team_idパラメータは無視される | High | pending | AC-U01-401 |
| TC-U01-007 | current_team_idでのデータ取得 | 一般ユーザーでログイン | ダッシュボードを表示 | `auth()->user()->currentTeam` のデータのみ取得される | High | pending | AC-U01-402 |

---

#### 5.2.11 G01: ログイン

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-G01-001 | ページ表示 | - | `/login` へアクセス | ロゴ、タイトル、メールアドレス入力欄、パスワード入力欄、ログインボタンが表示される | High | pending | AC-G01-101 |
| TC-G01-002 | 管理者ログイン（二段階認証フロー） | 管理者ユーザー（is_admin=true）が存在、ユーザーID=1の管理者が存在 | 正しいメールアドレスとパスワードでログイン | OTPコード生成 → ユーザーID=1へメール送信 → セッション保存 → ログアウト → G02へリダイレクト | High | pending | AC-G01-201, AC-G01-202 |
| TC-G01-003 | 一般ユーザーログイン | 一般ユーザー（is_admin=false）が存在 | 正しいメールアドレスとパスワードでログイン | U01（拠点ダッシュボード）へリダイレクト | High | pending | AC-G01-201, AC-G01-203 |
| TC-G01-004 | ログイン失敗（認証エラー） | - | 誤ったメールアドレスまたはパスワードでログイン | エラーメッセージ「メールアドレスまたはパスワードが正しくありません。」が表示される | High | pending | AC-G01-204 |
| TC-G01-005 | メールアドレス空エラー | - | メールアドレスを空でログイン試行 | バリデーションエラー「メールアドレスを入力してください」が表示される | High | pending | AC-G01-301 |
| TC-G01-006 | メールアドレス形式エラー | - | 不正な形式のメールアドレスでログイン試行 | バリデーションエラー「正しいメールアドレスを入力してください」が表示される | High | pending | AC-G01-302 |
| TC-G01-007 | パスワード空エラー | - | パスワードを空でログイン試行 | バリデーションエラー「パスワードを入力してください」が表示される | High | pending | AC-G01-303 |
| TC-G01-008 | Enterキー押下でログイン | メールアドレス・パスワード入力済み | Enterキーを押下 | ログインボタンクリックと同じ動作が実行される | Medium | pending | AC-G01-401 |
| TC-G01-009 | ログイン処理中のボタン無効化 | - | ログインボタンをクリック | ボタンが無効化され「認証中...」と表示される | Medium | pending | AC-G01-402 |
| TC-G01-010 | スーパー管理者不在エラー | 管理者ユーザー存在、ユーザーID=1が存在しない | 管理者でログイン試行 | エラーメッセージ「システムエラーが発生しました。管理者にお問い合わせください。」が表示される | High | pending | AC-G01-501 |

---

#### 5.2.12 G02: 二段階認証コード入力

**テストケース:**

| テストID | テスト項目 | 前提条件 | 入力/操作 | 期待値 | 優先度 | 実装状況 | 対応AC |
|---------|---------|---------|---------|--------|--------|--------|--------|
| TC-G02-001 | 直接アクセス（セッションなし） | セッションに「二段階認証待ち」フラグなし | `/two-factor-challenge` へGETリクエスト | G01へリダイレクト | High | pending | AC-G02-001 |
| TC-G02-002 | ページ表示 | 管理者ログイン後、二段階認証待ち | G02を表示 | 説明文、コード入力フィールド、3つのボタンが表示される | High | pending | AC-G02-002, AC-G02-003, AC-G02-004 |
| TC-G02-003 | OTPコード送信先 | 管理者ID=5がログイン | ログイン成功 | ユーザーID=1の管理者のメールアドレスにOTPコードが送信される | High | pending | AC-G02-101 |
| TC-G02-004 | OTPコード形式 | 管理者ログイン | メール受信 | 6桁の数字のOTPコードが含まれる | High | pending | AC-G02-102 |
| TC-G02-005 | OTPコード有効期限 | OTPコード生成 | 10分後にコードを入力 | 「有効期限が切れています」エラーが表示され、G01へリダイレクト | High | pending | AC-G02-103, AC-G02-204 |
| TC-G02-006 | ログイン試行者情報 | 管理者ID=5、名前「田中太郎」がログイン | メール受信 | メールにログイン試行者のID、名前、メールアドレスが含まれる | High | pending | AC-G02-104 |
| TC-G02-007 | 正しいOTPコード入力 | OTPコード送信済み | 正しい6桁のコードを入力して「認証する」をクリック | A01（管理者ダッシュボード）へリダイレクト | High | pending | AC-G02-201 |
| TC-G02-008 | 間違ったOTPコード入力 | OTPコード送信済み | 間違った6桁のコードを入力 | エラーメッセージ表示、試行回数+1 | High | pending | AC-G02-202 |
| TC-G02-009 | 試行回数超過（5回） | OTPコード送信済み | 5回連続で間違ったコードを入力 | トークン無効化、「試行回数の上限に達しました」エラー、G01へリダイレクト | High | pending | AC-G02-203 |
| TC-G02-010 | コード再送信 | OTPコード送信済み | 「コードを再送信」ボタンをクリック | 新しいOTPコードがユーザーID=1の管理者に送信され、トースト表示 | High | pending | AC-G02-301 |
| TC-G02-011 | ログアウトボタン | 二段階認証待ち | 「ログアウト」ボタンをクリック | セッションがクリアされ、G01へリダイレクト | High | pending | AC-G02-302 |
| TC-G02-012 | コード空エラー | 二段階認証待ち | コードを入力せずに「認証する」をクリック | 「認証コードを入力してください」バリデーションエラー | High | pending | AC-G02-401 |
| TC-G02-013 | コード6桁以外エラー | 二段階認証待ち | 5桁のコードを入力 | 「6桁の認証コードを入力してください」バリデーションエラー | High | pending | AC-G02-402 |

---

## 6. テスト実装優先度

### 6.1 優先度別ケース数

| 優先度 | ケース数 | 割合 |
|--------|---------|------|
| High | 146ケース | 97.3% |
| Medium | 4ケース | 2.7% |
| Low | 0ケース | 0% |
| **合計** | **150ケース** | **100%** |

### 6.2 Phase別実装計画

#### Phase 1（Week 1-3）: 認証・基本機能（High優先度）

**対象画面:**
- G01: ログイン（5ケース）
- G02: 二段階認証（13ケース）
- A01: 管理者ダッシュボード（12ケース）
- A02: 拠点一覧（17ケース）
- A03: 拠点編集（17ケース）
- U01: 拠点ダッシュボード（5ケース）

**合計:** 70ケース

#### Phase 2（Week 4-6）: CRUD機能・管理画面（High優先度）

**対象画面:**
- A04: CSV一括登録（19ケース）
- A05: Difyアプリ一覧（12ケース）
- A06: Difyアプリ編集（13ケース）
- A07: 利用状況一覧（23ケース）

**合計:** 67ケース

#### Phase 3（Week 7-8）: 特殊機能・エッジケース（High/Medium優先度）

**対象画面:**
- A08: 利用回数修正（4ケース）
- A09: 災害復旧エクスポート（9ケース）

**合計:** 13ケース

### 6.3 画面別優先度マトリクス

| 画面ID | 画面名 | High | Medium | Low | 合計 | Phase |
|--------|--------|------|--------|-----|------|-------|
| A01 | 管理者ダッシュボード | 12 | 1 | 0 | 13 | 1 |
| A02 | 拠点一覧 | 17 | 0 | 0 | 17 | 1 |
| A03 | 拠点編集 | 17 | 0 | 0 | 17 | 1 |
| A04 | CSV一括登録 | 18 | 1 | 0 | 19 | 2 |
| A05 | Difyアプリ一覧 | 12 | 0 | 0 | 12 | 2 |
| A06 | Difyアプリ編集 | 13 | 0 | 0 | 13 | 2 |
| A07 | 利用状況一覧 | 21 | 2 | 0 | 23 | 2 |
| A08 | 利用回数修正 | 4 | 0 | 0 | 4 | 3 |
| A09 | 災害復旧エクスポート | 9 | 0 | 0 | 9 | 3 |
| U01 | 拠点ダッシュボード | 5 | 0 | 0 | 5 | 1 |
| G01 | ログイン | 5 | 0 | 0 | 5 | 1 |
| G02 | 二段階認証 | 13 | 0 | 0 | 13 | 1 |
| **合計** | - | **146** | **4** | **0** | **150** | - |

**注:** A07にページ表示要素（ヘッダー、フィルタバー、テーブルカラム、初期値）、アプリフィルタ、制限超過フィルタ、CSV出力（UTF-8 BOM、フィルタ適用、全件出力）を反映。A09は全件エクスポート、APIキー平文出力、履歴記録不要に変更。G02（二段階認証）を追加：管理者ログイン時のメールOTP認証、ユーザーID=1の管理者への通知。

---

## 7. テスト実装ガイド

### 7.1 Feature Testの書き方

#### 基本パターン

```php
<?php

namespace Tests\Feature\Screens;

use Tests\TestCase;
use App\Models\User;
use App\Models\Team;
use Illuminate\Foundation\Testing\RefreshDatabase;

class A01AdminDashboardTest extends TestCase
{
    use RefreshDatabase;

    public function test_unauthenticated_user_redirected_to_login(): void
    {
        $response = $this->get('/admin');

        $response->assertRedirect('/login');
    }

    public function test_non_admin_user_gets_403(): void
    {
        $user = User::factory()->create(['is_admin' => false]);

        $response = $this->actingAs($user)->get('/admin');

        $response->assertStatus(403);
    }

    public function test_admin_user_can_view_dashboard(): void
    {
        $admin = User::factory()->create(['is_admin' => true]);
        Team::factory()->count(5)->create();

        $response = $this->actingAs($admin)->get('/admin');

        $response->assertStatus(200);
        $response->assertSee('契約拠点数');
        $response->assertSee('5'); // 拠点数
    }
}
```

### 7.2 Livewire Feature Testの書き方

```php
<?php

namespace Tests\Feature\Screens;

use Tests\TestCase;
use Livewire\Livewire;
use App\Models\User;
use App\Models\Team;
use App\Livewire\TeamList;
use Illuminate\Foundation\Testing\RefreshDatabase;

class A02TeamListTest extends TestCase
{
    use RefreshDatabase;

    public function test_can_search_teams(): void
    {
        $admin = User::factory()->create(['is_admin' => true]);
        Team::factory()->create(['name' => '東京本社']);
        Team::factory()->create(['name' => '大阪支社']);

        Livewire::actingAs($admin)
            ->test(TeamList::class)
            ->set('search', '東京')
            ->assertSee('東京本社')
            ->assertDontSee('大阪支社');
    }

    public function test_can_create_new_team(): void
    {
        $admin = User::factory()->create(['is_admin' => true]);

        Livewire::actingAs($admin)
            ->test(TeamList::class)
            ->call('openCreateModal')
            ->set('form.name', 'テスト拠点')
            ->set('form.plan_id', 1)
            ->set('form.owner_email', 'owner@example.com')
            ->set('form.owner_name', 'テストオーナー')
            ->call('createTeam')
            ->assertHasNoErrors();

        $this->assertDatabaseHas('teams', ['name' => 'テスト拠点']);
        $this->assertDatabaseHas('users', ['email' => 'owner@example.com']);
    }
}
```

### 7.3 データベーステストの書き方

```php
public function test_team_deletion_cascades_users(): void
{
    $admin = User::factory()->create(['is_admin' => true]);
    $team = Team::factory()->create();
    $user = User::factory()->create(['current_team_id' => $team->id]);

    $response = $this->actingAs($admin)
        ->delete("/admin/teams/{$team->id}");

    $response->assertRedirect('/admin/teams');
    $this->assertDatabaseMissing('teams', ['id' => $team->id]);
    $this->assertDatabaseMissing('users', ['id' => $user->id]);
}
```

### 7.4 バリデーションテストの書き方

```php
public function test_team_name_is_required(): void
{
    $admin = User::factory()->create(['is_admin' => true]);

    Livewire::actingAs($admin)
        ->test(TeamList::class)
        ->call('openCreateModal')
        ->set('form.name', '')
        ->set('form.plan_id', 1)
        ->call('createTeam')
        ->assertHasErrors(['form.name' => 'required']);
}
```

---

## 8. 付録

### 8.1 テストIDマトリクス（全ケース一覧）

| 画面ID | 画面名 | テストID範囲 | 総ケース数 |
|--------|--------|------------|----------|
| A01 | 管理者ダッシュボード | TC-A01-001 ~ TC-A01-013 | 13 |
| A02 | 拠点一覧 | TC-A02-001 ~ TC-A02-016 | 16 |
| A03 | 拠点編集 | TC-A03-001 ~ TC-A03-017 | 17 |
| A04 | CSV一括登録 | TC-A04-001 ~ TC-A04-019 | 19 |
| A05 | Difyアプリ一覧 | TC-A05-001 ~ TC-A05-012 | 12 |
| A06 | Difyアプリ編集 | TC-A06-001 ~ TC-A06-013 | 13 |
| A07 | 利用状況一覧 | TC-A07-001 ~ TC-A07-019 | 19 |
| A08 | 利用回数修正 | TC-A08-001 ~ TC-A08-004 | 4 |
| A09 | 災害復旧エクスポート | TC-A09-001 ~ TC-A09-007 | 7 |
| U01 | 拠点ダッシュボード | TC-U01-001 ~ TC-U01-005 | 5 |
| G01 | ログイン | TC-G01-001 ~ TC-G01-005 | 5 |
| **合計** | - | - | **130** |

**注:** アプリフィルタ、制限超過フィルタ、CSV出力（UTF-8 BOM、フィルタ適用、全件出力）を含む。

### 8.2 画面ID一覧

| 画面ID | 画面名 | URL |
|--------|--------|-----|
| A01 | 管理者ダッシュボード | `/admin` |
| A02 | 拠点一覧 | `/admin/teams` |
| A03 | 拠点編集 | `/admin/teams/{id}` |
| A04 | CSV一括登録 | `/admin/teams/import` |
| A05 | Difyアプリ一覧 | `/admin/apps` |
| A06 | Difyアプリ編集 | `/admin/apps/{id}` |
| A07 | 利用状況一覧 | `/admin/usages` |
| A08 | 利用回数修正 | (モーダル) |
| A09 | 災害復旧エクスポート | `/admin/dr/export` |
| U01 | 拠点ダッシュボード | `/dashboard` |
| G01 | ログイン | `/login` |

### 8.3 参照ドキュメント

#### プロジェクト内ドキュメント

- **画面仕様:** `.claude/02_ui_design/screens/`
- **コンポーネントテスト:** `.claude/01_development_docs/03_テストケース定義書.md`
- **要件定義書:** `.claude/01_development_docs/01_要件定義書.md`
- **機能一覧:** `.claude/01_development_docs/02_画面一覧・機能一覧定義書.md`

#### 外部リソース

- **Laravel Testing:** https://laravel.com/docs/12.x/testing
- **Livewire Testing:** https://livewire.laravel.com/docs/testing
- **PHPUnit:** https://phpunit.de/documentation.html

---

**ドキュメント作成日:** 2026-02-10
**バージョン:** 1.0
**作成者:** Claude Sonnet 4.5
